## 1.界面说明和展示
### 主界面
以下示例使用的模式是：无世界观 私聊通讯关 背景图开 简单npc档案 自定义选项区（无tag）

设置-显示设置：字体是通用仿宋 段落行间距1.8 界面字体大小23px 消息背景透明开启 全屏模式开 界面主题切换

<img width="1920" height="1080" alt="image" src="https://github.com/user-attachments/assets/a127304c-738f-402e-b048-f71099d1d6cd" />

#### 顶栏
左上角的`坛小球`：在接收到论坛消息时会闪烁。打开后会显示最近一次收到的论坛信息。当数据格式错误时无法正确显示。

之后的`总小球`：当你的任务进度抵达到100后，会发送提示词让AI生成任务总结，生成后的总结将会在此处显示。

 额外说明：当你完成任务的时候，AI会使用delete('world_set.npc','all')类似指令来清空所有的世界人物和世界信息以及所有的地图信息。这是一个特殊指令，它会清空任务、将任务进度强制设置为100来触发任务总结，并检测小总结数量，如果小总结大于20就会启动提前大总结。
 
 如果你想要保留某个npc，请在识小球的编辑那里打开该条目的防删除。地图请在地图界面的某个地图详情右上角的竖着的三个点打开防删除。
 
之后的`阅小球`：打开后，以阅读模式查看你的所有聊天记录。支持单独收藏、命名标题、编辑。

当你打开了私聊通讯或者使用诸天群聊模式，会有`聊小球`：顾名思义，是你的聊天界面。

右边的第一个按钮是快捷全屏

第二个是设置界面

第三个是刷新界面数据

第四个点击可以查看这一回合更新的特殊变量信息。

#### 中间
消息本体区域。电脑右键、手机长按可以唤出菜单。<img width="215" height="315" alt="image" src="https://github.com/user-attachments/assets/5ad71ceb-7327-42ff-b559-64d6ace9069b" />

复制功能在手机上用不了。

#### 底部
选项区长按可以放在令小盒中。

<img width="291" height="629" alt="image" src="https://github.com/user-attachments/assets/4b21988c-adba-4522-b8be-929fffdec5e5" />
这里可以重roll、继续或者自定义并发送qr。
<img width="900" height="735" alt="image" src="https://github.com/user-attachments/assets/66c20ed5-b53a-4341-98b9-5b558dd5eb26" />
RP是自选检定。
令小盒是待发送指令。

<img width="992" height="707" alt="image" src="https://github.com/user-attachments/assets/3fe36644-2564-4680-9fe6-c6ee0e100691" />
输入框上面是npc事件。可能会有平行事件的效果。

#### 右侧
先说重要的，综小球里面是大小总结，都可以编辑删除重命名，但是因为总结的一些特殊机制，编辑和重命名会将那个总结提前到最前面，需要注意。

识小球很重要。

npc如果有好感度，就会在名字右边出现好感度进度条。好感度不会在界面中具体显示，被隐藏了，算是为了美观。要修改好感度，只能在三个点那里点进去编辑，找到好感度去修改。
<img width="1014" height="751" alt="image" src="https://github.com/user-attachments/assets/309be908-6ad2-465f-9342-30442ddb2cc3" />
<img width="205" height="406" alt="image" src="https://github.com/user-attachments/assets/a4e59ff8-d690-492e-86b7-295dd3865492" />
这些功能从上到下分别的含义：

<img width="731" height="574" alt="image" src="https://github.com/user-attachments/assets/f94cde61-7cc2-41cf-a439-9f4030599c65" />
编辑：全部编辑，点击确定后，指令会被放入令小盒子。开启防删除后可以不再编辑，开启绿灯后这个条目会变成绿灯，根据这个条目的名字触发。探测的楼层默认是调试器中的这个配置，也可以在设置中单独配置。<img width="532" height="200" alt="image" src="https://github.com/user-attachments/assets/bb02cf5a-97af-4669-92ae-c8cb97316ce2" />

<img width="712" height="540" alt="image" src="https://github.com/user-attachments/assets/a771752c-8140-49b5-90db-210813039253" />
让AI重构：如图，可以快捷发送提示词让AI去重构，只是相当于一个qr而已。如：浓缩指令就是：`<request:请将路径（global_set.npc.不死川实弥的第二世记忆）的冗余内容进行浓缩，提炼其核心内容。在完成正文输出后，在updatememory块中先delete'global_set.npc.不死川实弥的第二世记忆'，再memory('global_set.npc', '不死川实弥的第二世记忆'...的浓缩后内容>`，这个常用于关键记忆太多的时候。

<img width="927" height="701" alt="image" src="https://github.com/user-attachments/assets/62b5a2ef-264f-4e04-9704-a909f06826d4" />
<img width="859" height="381" alt="image" src="https://github.com/user-attachments/assets/3f38d7df-af95-426e-b45c-effce4493b35" />
添加立绘：无论你有没有开npc立绘，你都可以使用这个功能。使用后，会在令小盒中存储指令，发送后才生效。
可以在底部的npc标签那里看到立绘，立绘会自动用洪水填充算法去除白色背景，效果如下：
<img width="421" height="737" alt="image" src="https://github.com/user-attachments/assets/960ed76c-5687-4b4a-bbf8-8771039cfc91" />
自己的素材在设置-素材工坊上传。

<img width="838" height="642" alt="image" src="https://github.com/user-attachments/assets/c0f03fb2-caf2-4f35-b6a7-1622b4e5487e" />
好感度表现：当你开启了分阶段好感后，当一个npc有好感度，那么AI会生成分阶段好感。你可以自由编辑，编辑后，指令依旧会放入令小盒。

能小球是你的个人信息界面，你的名字是可以点的，名字上面是你的称号，如果你开启了称号系统，那么你可以在那里管理你的称号。
<img width="958" height="756" alt="image" src="https://github.com/user-attachments/assets/1754cdb4-e260-4a33-8fa3-2abc44e40c83" />

你的装备加成、传奇属性加成、状态加成会用括号在你的属性右侧显示。点击装备栏可以进行装备的穿脱。你的背包的所有东西都可以穿上脱下。

你可以在术小球主动使用你的技能或投入你的意志力。
你的意志力如何恢复？你的行为符合你的美德时，回满；符合恶德时，意志力+1.

### 开局界面和mod说明
<img width="1919" height="949" alt="image" src="https://github.com/user-attachments/assets/5cef8a55-0d26-4d4e-85a3-ff7bacc6205d" />

进入无世界观的入口：<img width="609" height="282" alt="image" src="https://github.com/user-attachments/assets/9e8d4301-221a-4b45-ad8d-483815cbc769" />

#### 各个mod:
真实mod
会在开头加上一段真实世界引擎的cot思考，文风可能会更真实、更好，多出token 2000
困难 mod
难度会指数级上升，哈基米会给你各种找茬，以及强大的敌对小队。多出token 800
资源条
会有资源条固定每轮消耗，在能小球中显示资源条和相关信息。多出token 700
求生本能
在开启资源条的情况下，当你的资源告急，AI会主动驱使你求生。多出token二三十吧一个小功能
称号系统
在剧情中，如果达成什么成就（AI自己编的），会解锁对应成就（AI自己编的），可以在ui界面的自己人名的上面管理称号的穿戴。多出token 150
人外增强
在开启造物的情况下再开启此mod，开启后，造物的人外感将大大增强。开启此mod后，只会在造物没有初始化且在不在安全区的时候占用2000 token，平时不占用任何token。
强调时间
小总结会发送标题，每一轮正文代码会在最后印上剧情内部的时间地点戳。
特殊日期
AI在备忘录记录了节日、生日等特殊日期的时候，当那一天抵达，代码会通知AI那一天来临了。
回合战斗
开启后，当你进入战斗的时候，你会进入一个回合制战斗界面。
分阶段好感
当npc有好感度的时候，AI会给那个npc生成分阶段好感度。原理是：代码检测哪个npc有好感度但是还没有分阶段描述的时候，就会在下一轮给AI派发生成分阶段的任务。你可以在这个npc档案刚生成，还没有生成分阶段好感度的时候，用括号控制这个npc的好感度倾向。你可以在识小球设置这个分阶段文本是否显示。

### 设置界面
左上角是游戏成就，正文不生效。
 <img width="850" height="531" alt="image" src="https://github.com/user-attachments/assets/a2d2c520-c53d-4528-9eb9-e1ea1e14c8d7" />
在模组重置这里可以局内调整mod。如果你的正文生成的很多还有小剧场导致流式生成的卡卡的，可以切成非流。

<img width="855" height="445" alt="image" src="https://github.com/user-attachments/assets/37776739-6f3a-439d-9b00-686e9d16f9e4" />
这些顾名思义。好感度变速很好用，比如设置成2的话，好感度的上升和下降的速度就会减半。设置成999可以达到锁定好感度的功能，可以用于想和npc停滞在某个分阶段好感的时候。

系统更新检查这里，需要注意的是，强制更新世界书可能不会保存你的自定义词条。


### 核心调试器
<img width="545" height="155" alt="image" src="https://github.com/user-attachments/assets/5bc081fb-e842-41c6-a612-98d9e50b35a0" />
比较重要的是这个摘要的设置。
这个参数的意思是：只显示最近3楼的原本AI消息
当AI消息达到30楼的时候，将AI消息进行一次大总结
当大总结的数量达到20个的时候（也就是有600个AI消息，1200高度的楼层），将全部大总结再次浓缩为一个大总结。这个超级大浓缩作者亲测过了不太好用啊，哈基米有点脑力跟不上了，有时候不会大总结或者只总结最近的。为了保护存档，可以把这个设置调高一点，或者自己会的话就自己去手动大总结。这个的机制是，抵达了这个数量之后，代码会清空前面所有的大总结，只保留这一个。想自己手操的话可以在discord @assa 。


<img width="748" height="263" alt="image" src="https://github.com/user-attachments/assets/367f0f8c-8c93-4497-8a0c-273e7282ddd9" />
整合重构可以获取所有聊天记录的所有变量重新执行。重新处理是重新处理上一楼AI消息的变量。手动执行是执行输入框内的变量指令。

## 2.开局界面


# 进阶：memory变量系统说明文档

## 1. 系统概述

 它旨在通过三个核心数据模块——`play_character_data`、`stat_data` 和 `assa_data`——来精确追踪和管理角色状态、世界实时信息以及持久化世界资产。
 
### 1.1 核心模块

*   `play_character_data`: 定义角色的“本质”，包括其属性、技能、天赋等，这些是角色的成长核心。
*   `stat_data`: 捕获“当前时刻”的快照，包括时间、地点、任务进度、战斗状态等。它在每个回合都可能发生剧烈变化。
*   `assa_data`: 存储需要跨越时间和场景的“世界资产”，如NPC信息、全局设定、地图数据以及用于长期记忆的摘要。

---

## 2. 核心变量结构 

 大部分数据项遵循 `[值, "描述"]` 的数组格式，第一个元素是实际数据，第二个元素是其功能说明。

### 2.1. 角色数据 (`play_character_data`)

定义角色的核心面板，是角色的“人物卡”。

*   **概念段**: 定义角色的核心理念。
    *   `美德与恶德`: `["正义", "符合条件时回复所有意志力"]` - 角色在特定行为后获得奖励的核心驱动力。
    *   `缺陷天赋怪癖`: 角色的独有特性，为角色扮演提供指引。
*   **属性段**: 角色的九大核心基础属性，数值范围理论上无上限。
    *   `生理属性`: `力量`, `敏捷`, `耐力`
    - `心智属性`: `智力`, `感知`, `决心`
    *   `互动属性`: `风度`, `操控`, `沉着`
    *   每个属性下分 `基础` 和 `传奇`。`传奇` 属性是当 `基础` 属性超过8点后自动计算的额外加值 (`传奇` = `基础` - 8)，用于提供强大的附加成功。
*   **技能段**: 角色的后天能力，与属性结合进行检定。
    *   `生理技能`: `运动`, `肉搏`, `白刃` 等。
    *   `心智技能`: `学识`, `调查`, `神秘学` 等。
    *   `互动技能`: `感受`, `胁迫`, `掩饰` 等。
*   **能力段**: 超出普通技能范畴的特殊能力，如血统、功法、超能力等。
*   **衍生属性段**: **由系统自动计算，请勿手动修改。**
    *   `体积`: 影响生命值和速度。
    *   `速度`: `基础速度` = (`力量` + `敏捷` + `体积`) / 3.
    *   `先攻`: `敏捷` + `沉着` / 2.
    *   `防御`: `Min(敏捷, 感知)`.
    *   `生命值`: `上限` = `体积`*10 + `耐力`*20。
    *   `意志力`: `上限` = `决心` + `沉着`。
    *   `感知范围`: `敏感范围` = `感知` * 10米。
    *   `豁免检定基础`: `强韧`, `反射`, `意志`，由相关属性和技能决定。
*   **货币段**: 角色拥有的交易媒介。
    *   `支线剧情`: D/C/B/A/S级，用于兑换特殊奖励。
    *   `积分`: 通用货币。
    *   `经验值`: 用于提升属性和技能。

### 2.2. 实时状态数据 (`stat_data`)

记录当前回合的上下文信息。

*   **时间与环境**:
    *   `纪年`, `日期`, `星期`, `时间`: 构成完整的游戏内时间坐标。`日期` 和 `时间` 的变动是驱动世界时间流逝的核心。
    *   `天气`: 描述当前环境。
*   **世界分片 (`world_shard`)**: 描述当前所在的任务世界。
    *   `name`, `description`, `level`: 世界的名称、描述和能量层级。
    *   `task`: 任务系统。
        *   `objective`: 任务目标。
        *   `progress`: 任务进度百分比。
        *   `time_limit`: 任务总时限（天数）。
        *   `time_left`: **自动计算的剩余天数，严禁手动修改。**
*   **造物 (`the_created`)**: 如果当前世界存在你的造物，这里会记录其详细状态。
*   **用户角色状态 (`user_character`)**:
    *   `current_location`: 当前所处的精确位置。
    *   `当前装备`: 记录角色手持和穿戴的装备。
*   **检定与战斗**:
    *   `检定属性`: AI设置的、建议下一轮进行的检定组合，如 `力量;白刃`。
    *   `检定难度`: AI预测的行动难度等级。
    *   `敌方攻击骰池`: 如果处于战斗中，记录敌人即将发动的攻击及其强度，如 `力量:2;白刃:2`。

### 2.3. 世界资产与记忆数据 (`assa_data`)

存储世界的持久化信息和长期记忆。

*   **`global_set` 与 `world_set`**:
    *   `npc`: 存储NPC的详细数据，支持任意层级的嵌套。
    *   `settings`: 存储各种世界规则和设定。
    *   `global_set` 存储跨世界通用的信息，`world_set` 存储当前世界专属的信息。当离开世界时，通过`delete('world_set.npc','all');`和`delete('world_set.settings','all');`来清空`world_set` 的全部内容，并备份到对应世界书词条。
*   **背包 (`global_set.背包`)**: 存储玩家的物品。系统具有**自动清理机制**，当任何物品的 `num` (数量) 变为`0`时，该物品条目会自动从背包中移除。
*   **地图系统 (`map`)**:
    *   `全局地点表`, `主要地点表`: 以表格形式存储世界的地理信息。
*   **摘要系统 (`summary`) 与配置 (`config`)**: **这是系统的核心记忆机制。**
    *   `summary.small`: 存储最近的、详细的短期记忆。
    *   `summary.big`: 存储经过提炼的、关键的长期记忆节点。
    *   `config`: 控制摘要系统的行为参数。详见 3.2.1 节。

---

## 3. 主要功能与操作指令

所有操作通过在AI或用户输入中嵌入特定格式的指令来完成。

### 3.1. 基础数据操作

```javascript
// 修改角色属性或货币。路径是相对于 play_character_data 的。
// 格式: set_attribute('路径', 0, 新数值)。也可以不给出旧值。
set_attribute('属性段.生理属性.力量.基础', 0, 10);
set_attribute('货币段.积分', 0, 5000);

// 修改实时状态数据。路径是相对于 stat_data 的。
// 格式: set_status('路径', '新数值');
set_status('user_character.current_location', '黑森林深处');
set_status('world_shard.task.progress', 100);

// 增加或修改世界资产。路径是相对于 assa_data 的。
// 格式: memory('父路径', '键', '值'); 值可以是字符串、数字或JSON对象。
memory('world_set.npc', '老铁匠', '{"描述":"一位技艺精湛但脾气古怪的铁匠","好感度":50}');
memory('global_set.背包.治疗药水', '{"num":10, "description":"恢复少量生命值"}');

// 删除世界资产。
// 格式: delete('父路径', '键');
delete('world_set.npc', '被击败的哥布林');

// 清空一整个分类（如所有当前世界的NPC）
delete('world_set.npc', 'all');
 
```

### 3.2. 高级自动化与核心机制

#### 3.2.1. 摘要系统 (Summary) 详解

摘要系统是实现长程记忆和控制上下文长度的关键。它通过大小总结的流动机制，将海量信息提炼为关键记忆。

*   **工作流程**:
    1.  所有近期的详细信息通过 `memory` 指令存入 `summary.small`。
    2.  当 `summary.small` 中的条目数量达到 `config.small_to_big_count`（例如50条），系统会升起一个“清理旗帜” `config.flags.clean_small_flag`。
    3.  AI在下一次生成时，会基于已满的 `summary.small` 内容，提炼出一个关键的长期记忆节点，并存入 `summary.big`。
    4.  系统检测到 `summary.big` 已更新，并且清理旗帜是升起状态，就会自动清空 `summary.small`，为新的短期记忆腾出空间，并降下旗帜。
    5.  `summary.big` 自身也有类似的清理机制，由 `config.clean_big_count` 控制，保留最新的记忆。
*   **配置项 (`config`)**:
    *   `small_to_big_count`: 触发小总结清理的阈值。
    *   `clean_big_count`: 触发大总结清理的阈值。
    *   `hide_latest_count`: 在生成上下文时，隐藏最新的几条 `summary.big`，防止AI直接复述刚刚总结过的内容。

#### 3.2.2. 时间流逝与自动演算

系统会根据 `stat_data.日期` 和 `stat_data.时间` 的变化，自动计算时间的流逝。

*   **任务时间 (`time_left`)**: 当任务的 `time_limit` 被设定后，系统会记录一个起始日期 `start_date`。在每一轮结束后，系统会比较当前日期与起始日期，自动计算 `daysElapsed`（流逝天数），并更新 `time_left` (`time_limit` - `daysElapsed`)。**此过程全自动，严禁手动修改 `time_left`。**
*   **资源自然增长**: 当你在地图 地点 的 `resources` 中设置了每日产出（如 `["3/d", 100]`，表示每日产出3个，当前存量100），系统会在检测到游戏内日期跨天时，自动根据流逝的天数乘以每日产出，更新资源存量。这同样适用于负产出（消耗）。

#### 3.2.3. 数据持久化与重构

*   **快照备份**: 每一条消息（用户或AI）都会在 `message` 域中保存一份发出该消息时完整的 `variables` 数据快照。此功能目前是冗余的，也就是没用，因为我们的0层。
*   **历史重构 (`rebuildWorldFromHistory`)**: 这是一个强大的纠错功能。当数据出现严重不一致时，可以使用此功能。它会：
    1.  将当前世界状态完全重置。
    2.  读取存储在0号消息中的完整历史记录。
    3.  按顺序重新执行历史记录中所有的操作指令。
    4.  最终，将世界恢复到一个绝对准确、与历史记录完全一致的状态。这是保证世界数据最终一致性的最终手段。

---

## 4. 附录

### 4.1. `memory` 指令高级用法 (移动与重命名)

`memory` 指令除了基本的增改功能外，还支持通过提供两个路径参数来实现移动或重命名节点。

```javascript
// 重命名：父路径相同，键名不同
// 将'老铁匠'重命名为'宗师铁匠'
memory('world_set.npc.老铁匠', 'world_set.npc.宗师铁匠');

// 移动：父路径不同，键名相同
// 将'传奇宝剑'从NPC'宗师铁匠'的物品栏移动到玩家的背包
memory('world_set.npc.宗师铁匠.物品.传奇宝剑', 'global_set.背包.传奇宝剑');
```

### 4.2. 数据保护机制 (`_is_protected`)

为了防止重要数据被意外删除，你可以在任何一个数据节点（如一个NPC条目）中添加一个 `"_is_protected": true` 的键值对。
 
```javascript
memory('world_set.settings', '世界基石', '{"描述":"不可动摇的世界规则", "_is_protected": true}');
```

当 `delete` 指令（包括 `delete('world_set.settings', 'all')`）尝试删除一个带有此标记的节点时，操作将被阻止，该节点会被安全地保留下来。这是守护核心世界设定不被污染的重要机制。

### 4.3. 上下文感知机制 (“绿灯”机制)

这是一个动态信息过滤系统，旨在根据对话的即时上下文，智能地控制 `assa_data` 中特定信息在发送给AI的提示词（在世界书中）的显示与隐藏，从而优化AI的信息摄入和用户界面的清爽度。

*   **启用方式**:
    在任何你希望进行动态控制的数据节点（必须是对象）中，添加一个标记：`"_filter": true`。
    ```javascript
    // 示例：为一个NPC启用上下文感知
    *.memory('world_set.npc', '神秘的线人', '{"任务线索":"...", "_filter": true}');
    ```

*   **工作原理**:
    1.  **关键词提取**: 系统会将启用了 `_filter` 的数据节点的路径进行拆分，并将其路径的第三层（如 `world_set.npc.神秘的线人` 中的 `神秘的线人`）作为“关键词”。
    2.  **上下文扫描**: 系统会自动扫描最近几轮（即hide_latest_count默认为5轮）AI的回复内容。
    3.  **状态切换**:
    如果在最近的回复中找到了该“关键词”，系统会认为该信息与当前对话相关，并自动执行一条 `memory` 指令，将该节点的 `_showInEJS` 属性设置为 `true`。
     如果未找到关键词，系统则会将 `_showInEJS` 属性设置为 `false`。
    4.  **提示词渲染**: 世界书渲染逻辑会检查 `_showInEJS` 属性。如果其值为 `false` 或 `'false'`，则会将该节点的全部内容渲染为 `"[已隐藏] 请勿修改或重新初始化此字段"`，从而实现了信息的动态过滤。

*   **核心目的**:
    该机制确保了只有在被明确提及或讨论时，复杂的、次要的信息才会被完整地加载到上下文中。在平时，它们则被“收起”，既能保证AI不会被无关信息干扰，也让前端显示的数据结构更加简洁明了。

### 4.4. 世界层级与检定难度标尺

系统通过 `stat_data.world_shard.level[0]` 中定义的“世界层级”来为整个世界的超凡强度和危险等级定下基调。这直接影响了AI在设置 `stat_data.检定难度[0]` 时的上限和语义。

*   **世界层级分类**:

| 层级 (`level`) | 描述 | 最大检定难度 |
| :--- | :--- | :--- |
| **无** | 普通现实世界，遵循基础物理规则。 | 3 |
| **低** | 如金庸武侠世界，存在超出常人的技艺，但本质仍是凡人界限。 | 5 |
| **中** | 存在明确的超凡力量（魔法、异能），但影响范围有限。 | 7 |
| **高** | 强大的超凡力量广泛存在，可能导致区域性的现实扭曲。 | 12 |
| **神话**| 神明或宇宙级力量直接干预现实，世界规则可能被彻底重写。 | 16 |

 
