 
# memory变量系统说明文档

## 1. 系统概述

 它旨在通过三个核心数据模块——`play_character_data`、`stat_data` 和 `assa_data`——来精确追踪和管理角色状态、世界实时信息以及持久化世界资产。
 
### 1.1 核心模块

*   `play_character_data`: 定义角色的“本质”，包括其属性、技能、天赋等，这些是角色的成长核心。
*   `stat_data`: 捕获“当前时刻”的快照，包括时间、地点、任务进度、战斗状态等。它在每个回合都可能发生剧烈变化。
*   `assa_data`: 存储需要跨越时间和场景的“世界资产”，如NPC信息、全局设定、地图数据以及用于长期记忆的摘要。

---

## 2. 核心变量结构 

 大部分数据项遵循 `[值, "描述"]` 的数组格式，第一个元素是实际数据，第二个元素是其功能说明。

### 2.1. 角色数据 (`play_character_data`)

定义角色的核心面板，是角色的“人物卡”。

*   **概念段**: 定义角色的核心理念。
    *   `美德与恶德`: `["正义", "符合条件时回复所有意志力"]` - 角色在特定行为后获得奖励的核心驱动力。
    *   `缺陷天赋怪癖`: 角色的独有特性，为角色扮演提供指引。
*   **属性段**: 角色的九大核心基础属性，数值范围理论上无上限。
    *   `生理属性`: `力量`, `敏捷`, `耐力`
    - `心智属性`: `智力`, `感知`, `决心`
    *   `互动属性`: `风度`, `操控`, `沉着`
    *   每个属性下分 `基础` 和 `传奇`。`传奇` 属性是当 `基础` 属性超过8点后自动计算的额外加值 (`传奇` = `基础` - 8)，用于提供强大的附加成功。
*   **技能段**: 角色的后天能力，与属性结合进行检定。
    *   `生理技能`: `运动`, `肉搏`, `白刃` 等。
    *   `心智技能`: `学识`, `调查`, `神秘学` 等。
    *   `互动技能`: `感受`, `胁迫`, `掩饰` 等。
*   **能力段**: 超出普通技能范畴的特殊能力，如血统、功法、超能力等。
*   **衍生属性段**: **由系统自动计算，请勿手动修改。**
    *   `体积`: 影响生命值和速度。
    *   `速度`: `基础速度` = (`力量` + `敏捷` + `体积`) / 3.
    *   `先攻`: `敏捷` + `沉着` / 2.
    *   `防御`: `Min(敏捷, 感知)`.
    *   `生命值`: `上限` = `体积`*10 + `耐力`*20。
    *   `意志力`: `上限` = `决心` + `沉着`。
    *   `感知范围`: `敏感范围` = `感知` * 10米。
    *   `豁免检定基础`: `强韧`, `反射`, `意志`，由相关属性和技能决定。
*   **货币段**: 角色拥有的交易媒介。
    *   `支线剧情`: D/C/B/A/S级，用于兑换特殊奖励。
    *   `积分`: 通用货币。
    *   `经验值`: 用于提升属性和技能。

### 2.2. 实时状态数据 (`stat_data`)

记录当前回合的上下文信息。

*   **时间与环境**:
    *   `纪年`, `日期`, `星期`, `时间`: 构成完整的游戏内时间坐标。`日期` 和 `时间` 的变动是驱动世界时间流逝的核心。
    *   `天气`: 描述当前环境。
*   **世界分片 (`world_shard`)**: 描述当前所在的任务世界。
    *   `name`, `description`, `level`: 世界的名称、描述和能量层级。
    *   `task`: 任务系统。
        *   `objective`: 任务目标。
        *   `progress`: 任务进度百分比。
        *   `time_limit`: 任务总时限（天数）。
        *   `time_left`: **自动计算的剩余天数，严禁手动修改。**
*   **造物 (`the_created`)**: 如果当前世界存在你的造物，这里会记录其详细状态。
*   **用户角色状态 (`user_character`)**:
    *   `current_location`: 当前所处的精确位置。
    *   `当前装备`: 记录角色手持和穿戴的装备。
*   **检定与战斗**:
    *   `检定属性`: AI设置的、建议下一轮进行的检定组合，如 `力量;白刃`。
    *   `检定难度`: AI预测的行动难度等级。
    *   `敌方攻击骰池`: 如果处于战斗中，记录敌人即将发动的攻击及其强度，如 `力量:2;白刃:2`。

### 2.3. 世界资产与记忆数据 (`assa_data`)

存储世界的持久化信息和长期记忆。

*   **`global_set` 与 `world_set`**:
    *   `npc`: 存储NPC的详细数据，支持任意层级的嵌套。
    *   `settings`: 存储各种世界规则和设定。
    *   `global_set` 存储跨世界通用的信息，`world_set` 存储当前世界专属的信息。当离开世界时，通过`delete('world_set.npc','all');`和`delete('world_set.settings','all');`来清空`world_set` 的全部内容，并备份到对应世界书词条。
*   **背包 (`global_set.背包`)**: 存储玩家的物品。系统具有**自动清理机制**，当任何物品的 `num` (数量) 变为`0`时，该物品条目会自动从背包中移除。
*   **地图系统 (`map`)**:
    *   `全局地点表`, `主要地点表`: 以表格形式存储世界的地理信息。
*   **摘要系统 (`summary`) 与配置 (`config`)**: **这是系统的核心记忆机制。**
    *   `summary.small`: 存储最近的、详细的短期记忆。
    *   `summary.big`: 存储经过提炼的、关键的长期记忆节点。
    *   `config`: 控制摘要系统的行为参数。详见 3.2.1 节。

---

## 3. 主要功能与操作指令

所有操作通过在AI或用户输入中嵌入特定格式的指令来完成。

### 3.1. 基础数据操作

```javascript
// 修改角色属性或货币。路径是相对于 play_character_data 的。
// 格式: set_attribute('路径', 0, 新数值)。也可以不给出旧值。
set_attribute('属性段.生理属性.力量.基础', 0, 10);
set_attribute('货币段.积分', 0, 5000);

// 修改实时状态数据。路径是相对于 stat_data 的。
// 格式: set_status('路径', '新数值');
set_status('user_character.current_location', '黑森林深处');
set_status('world_shard.task.progress', 100);

// 增加或修改世界资产。路径是相对于 assa_data 的。
// 格式: memory('父路径', '键', '值'); 值可以是字符串、数字或JSON对象。
memory('world_set.npc', '老铁匠', '{"描述":"一位技艺精湛但脾气古怪的铁匠","好感度":50}');
memory('global_set.背包.治疗药水', '{"num":10, "description":"恢复少量生命值"}');

// 删除世界资产。
// 格式: delete('父路径', '键');
delete('world_set.npc', '被击败的哥布林');

// 清空一整个分类（如所有当前世界的NPC）
delete('world_set.npc', 'all');
 
```

### 3.2. 高级自动化与核心机制

#### 3.2.1. 摘要系统 (Summary) 详解

摘要系统是实现长程记忆和控制上下文长度的关键。它通过大小总结的流动机制，将海量信息提炼为关键记忆。

*   **工作流程**:
    1.  所有近期的详细信息通过 `memory` 指令存入 `summary.small`。
    2.  当 `summary.small` 中的条目数量达到 `config.small_to_big_count`（例如50条），系统会升起一个“清理旗帜” `config.flags.clean_small_flag`。
    3.  AI在下一次生成时，会基于已满的 `summary.small` 内容，提炼出一个关键的长期记忆节点，并存入 `summary.big`。
    4.  系统检测到 `summary.big` 已更新，并且清理旗帜是升起状态，就会自动清空 `summary.small`，为新的短期记忆腾出空间，并降下旗帜。
    5.  `summary.big` 自身也有类似的清理机制，由 `config.clean_big_count` 控制，保留最新的记忆。
*   **配置项 (`config`)**:
    *   `small_to_big_count`: 触发小总结清理的阈值。
    *   `clean_big_count`: 触发大总结清理的阈值。
    *   `hide_latest_count`: 在生成上下文时，隐藏最新的几条 `summary.big`，防止AI直接复述刚刚总结过的内容。

#### 3.2.2. 时间流逝与自动演算

系统会根据 `stat_data.日期` 和 `stat_data.时间` 的变化，自动计算时间的流逝。

*   **任务时间 (`time_left`)**: 当任务的 `time_limit` 被设定后，系统会记录一个起始日期 `start_date`。在每一轮结束后，系统会比较当前日期与起始日期，自动计算 `daysElapsed`（流逝天数），并更新 `time_left` (`time_limit` - `daysElapsed`)。**此过程全自动，严禁手动修改 `time_left`。**
*   **资源自然增长**: 当你在地图 地点 的 `resources` 中设置了每日产出（如 `["3/d", 100]`，表示每日产出3个，当前存量100），系统会在检测到游戏内日期跨天时，自动根据流逝的天数乘以每日产出，更新资源存量。这同样适用于负产出（消耗）。

#### 3.2.3. 数据持久化与重构

*   **快照备份**: 每一条消息（用户或AI）都会在 `message` 域中保存一份发出该消息时完整的 `variables` 数据快照。此功能目前是冗余的，也就是没用，因为我们的0层。
*   **历史重构 (`rebuildWorldFromHistory`)**: 这是一个强大的纠错功能。当数据出现严重不一致时，可以使用此功能。它会：
    1.  将当前世界状态完全重置。
    2.  读取存储在0号消息中的完整历史记录。
    3.  按顺序重新执行历史记录中所有的操作指令。
    4.  最终，将世界恢复到一个绝对准确、与历史记录完全一致的状态。这是保证世界数据最终一致性的最终手段。

---

## 4. 附录

### 4.1. `memory` 指令高级用法 (移动与重命名)

`memory` 指令除了基本的增改功能外，还支持通过提供两个路径参数来实现移动或重命名节点。

```javascript
// 重命名：父路径相同，键名不同
// 将'老铁匠'重命名为'宗师铁匠'
memory('world_set.npc.老铁匠', 'world_set.npc.宗师铁匠');

// 移动：父路径不同，键名相同
// 将'传奇宝剑'从NPC'宗师铁匠'的物品栏移动到玩家的背包
memory('world_set.npc.宗师铁匠.物品.传奇宝剑', 'global_set.背包.传奇宝剑');
```

### 4.2. 数据保护机制 (`_is_protected`)

为了防止重要数据被意外删除，你可以在任何一个数据节点（如一个NPC条目）中添加一个 `"_is_protected": true` 的键值对。
 
```javascript
memory('world_set.settings', '世界基石', '{"描述":"不可动摇的世界规则", "_is_protected": true}');
```

当 `delete` 指令（包括 `delete('world_set.settings', 'all')`）尝试删除一个带有此标记的节点时，操作将被阻止，该节点会被安全地保留下来。这是守护核心世界设定不被污染的重要机制。

### 4.3. 上下文感知机制 (“绿灯”机制)

这是一个动态信息过滤系统，旨在根据对话的即时上下文，智能地控制 `assa_data` 中特定信息在发送给AI的提示词（在世界书中）的显示与隐藏，从而优化AI的信息摄入和用户界面的清爽度。

*   **启用方式**:
    在任何你希望进行动态控制的数据节点（必须是对象）中，添加一个标记：`"_filter": true`。
    ```javascript
    // 示例：为一个NPC启用上下文感知
    *.memory('world_set.npc', '神秘的线人', '{"任务线索":"...", "_filter": true}');
    ```

*   **工作原理**:
    1.  **关键词提取**: 系统会将启用了 `_filter` 的数据节点的路径进行拆分，并将其路径的第三层（如 `world_set.npc.神秘的线人` 中的 `神秘的线人`）作为“关键词”。
    2.  **上下文扫描**: 系统会自动扫描最近几轮（即hide_latest_count默认为5轮）AI的回复内容。
    3.  **状态切换**:
    如果在最近的回复中找到了该“关键词”，系统会认为该信息与当前对话相关，并自动执行一条 `memory` 指令，将该节点的 `_showInEJS` 属性设置为 `true`。
     如果未找到关键词，系统则会将 `_showInEJS` 属性设置为 `false`。
    4.  **提示词渲染**: 世界书渲染逻辑会检查 `_showInEJS` 属性。如果其值为 `false` 或 `'false'`，则会将该节点的全部内容渲染为 `"[已隐藏] 请勿修改或重新初始化此字段"`，从而实现了信息的动态过滤。

*   **核心目的**:
    该机制确保了只有在被明确提及或讨论时，复杂的、次要的信息才会被完整地加载到上下文中。在平时，它们则被“收起”，既能保证AI不会被无关信息干扰，也让前端显示的数据结构更加简洁明了。

### 4.4. 世界层级与检定难度标尺

系统通过 `stat_data.world_shard.level[0]` 中定义的“世界层级”来为整个世界的超凡强度和危险等级定下基调。这直接影响了AI在设置 `stat_data.检定难度[0]` 时的上限和语义。

*   **世界层级分类**:

| 层级 (`level`) | 描述 | 最大检定难度 |
| :--- | :--- | :--- |
| **无** | 普通现实世界，遵循基础物理规则。 | 3 |
| **低** | 如金庸武侠世界，存在超出常人的技艺，但本质仍是凡人界限。 | 5 |
| **中** | 存在明确的超凡力量（魔法、异能），但影响范围有限。 | 7 |
| **高** | 强大的超凡力量广泛存在，可能导致区域性的现实扭曲。 | 12 |
| **神话**| 神明或宇宙级力量直接干预现实，世界规则可能被彻底重写。 | 16 |

 