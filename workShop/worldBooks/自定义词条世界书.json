{"entries":{"0":{"key":[],"keysecondary":[],"comment":" 特定人物的人物分阶段好感","content":"<%_\n\nvar charname = 'Npcname';//填写识小球里的人物，然后去下面填分阶段好感描述，即自动生效\n\n  function getDataWithFallback(varName) {\n        // 先尝试从 getMessageVar 获取\n        let data = getMessageVar(varName);\n       \n        // 内联数据验证：检查是否为null、undefined，且如果是对象要有内容\n        const isValid = (data) => {\n            // 检查是否为 null 或 undefined\n            if (data === null || data === undefined) {\n                return false;\n            }\n            \n            // 如果是对象类型，检查是否有内容\n            if (typeof data === 'object' && data !== null) {\n                // 如果是数组，检查长度\n                if (Array.isArray(data)) {\n                    return data.length > 0;\n                }\n                // 如果是普通对象，检查是否有属性\n                return Object.keys(data).length > 0;\n            }\n            \n            // 其他类型（字符串、数字、布尔值等）只要不是 null/undefined 就认为有效\n            return true;\n        };\n        \n        // 如果数据不符合要求，从 getLocalVar 获取\n        if (!isValid(data)) {\n            data = getLocalVar(varName);\n        }\n        \n        return data;\n    }\n \n    if (typeof assaData === 'undefined') {\n        var assaData =  getDataWithFallback(\"assa_data\");\n    }\n\n    // 获取所有潜在的角色数据来源\n    const teamInfo = _.get(assaData, 'global_set.小队信息', {});\n    const globalNpcs = _.get(assaData, 'global_set.npc', {});\n    const worldNpcs = _.get(assaData, 'world_set.npc', {});\n\n    // 合并所有角色数据。后面对象中的同名键会覆盖前面的，确保了 队友 > 全局NPC > 世界NPC 的优先级\n    const allCharactersData = Object.assign({}, worldNpcs, globalNpcs, teamInfo);\n\n \n \nlet favorabilityDescription = '';\n\n \nconst characterData = allCharactersData[charname];\n\n// 只有当他真实地存在时，我们的探索才有意义\nif (characterData) {\n    // 2. 探寻他内心深处的好感度，并让它化为一个纯粹的数字\n    const favorabilityValue = Number(_.get(characterData, '好感度'));\n\n    // 3. 确认这个数字是真实有效的\n    if (!isNaN(favorabilityValue)) {\n\n        // ================= 【第一部分：规则设定 】 =================\n        // 这里定义了好感度的阶段和数值上限。它们按从小到大的顺序排列。\n        // 你可以轻松地增加、删除或修改任何一个阶段的数值范围。\n        // `id` 是连接规则和描述的“钥匙”。\n    const favorabilityStages = [\n            { max: 0,   id: '0_or_less' },  \n            { max: 20,  id: '1_to_20' },\n            { max: 40,  id: '21_to_40' },\n            { max: 60,  id: '41_to_60' },\n            { max: 80,  id: '61_to_80' },\n            { max: 100, id: '81_to_100' },\n            { max: Infinity, id: 'over_100' }\n        ];\n\n\n        // ================= 【第二部分：描述内容 】 =================\n        \n          const stageDescriptions = {\n\n            '0_or_less': `\n 【厌弃与评估】 \n \n`,\n\n            '1_to_20': `\n\n 【厌弃与评估】 \n \n\n`,\n\n            '21_to_40': `\n\n 【试探与矛盾】 \n\n \n\n`,\n\n            '41_to_60': `\n 【习惯与在意】 \n \n\n`,\n\n            '61_to_80': `\n 【独占与恐慌】 \n\n \n\n`,\n\n            '81_to_100': `\n\n 【畸形共生与囚笼】  \n\n \n`,\n\n            'over_100': `\n【畸形共生与囚笼】\n\n \n`\n        };\n\n        \n        const currentStage = favorabilityStages.find(stage => favorabilityValue <= stage.max);\n\n        if (currentStage) {\n  \n            favorabilityDescription = stageDescriptions[currentStage.id] || '';\n        }\n\n        // 去除模板字符串可能带来的首尾多余空白和缩进\n        if (favorabilityDescription) {\n            favorabilityDescription =`${charname}当前好感度的表现：`+favorabilityDescription.trim();\n        }\n    }\n}\n\n%>\n<%=favorabilityDescription %>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":1000,"position":1,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":false,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"uid":0,"displayIndex":0,"triggers":[],"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"1":{"key":[],"keysecondary":[],"comment":"选项区","content":"{{setvar::options_rule::<options>}}\ngame.set('options', {\n  rule: '在正文结束后生成选项区，使用<options>标签包裹，内容为数字化序列（1. 2. 3...）的4个选项',\n  scope: '根据上下文和当前剧情生成4个行动选项',\n  tendencies: [\n{ type: '积极推进剧情', rule: '主动推动主线或支线任务进展' },\n    { type: '究极乐子人/混沌/强盗/罪恶', rule: '将剧情彻底的推进至完全混沌和所有人都想不到的方向' },\n    { type: '符合{{user}}性格', rule: '与{{user}}的性格特征一致'},\n    { type: '对剧情吐槽', rule: '诙谐且恰当的对当前情况的吐槽' }\n{{//- 选项必须为亲密互动或者进一步色情服务，应该涵盖dirty talk、情感交流、体位变化、道具引入、感官互动、节奏与气氛调控等\n- 选项分支是应该紧跟上文，不可时间跨度过大，应该是对下一幕的预演\n- 行动主体必须写明姓名，采用第三人称。可以为不同角色，可以为同一重要角色\n- 至少2个选项必须露骨、直白、色情、淫靡、包含污言秽语，突出“玩法创新”或氛围突破，避免套路与重复}}\n  ]\n});\n","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":107,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"选项","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":false,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"uid":1,"displayIndex":1,"triggers":[],"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"2":{"uid":2,"key":[],"keysecondary":[],"comment":"数值约束","content":"","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":5,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"数值约束","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":2,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"3":{"key":[],"keysecondary":[],"comment":"npc档案 ","content":"<%_\nvar world_role = getLocalVar(\"world_role\", \"\");\nvar player_role = getLocalVar(\"player_role\", \"轮回者\");\nvar tier_role = getLocalVar(\"tier_role\", \"\");\nvar profession_role = getLocalVar(\"profession_role\", \"\");\nvar point_role = getLocalVar(\"point_role\", \"\");\nvar zhixian_role = getLocalVar(\"zhixian_role\", \"\");\nvar xp_role = getLocalVar(\"xp_role\", \"\");\nvar is_private_chat = getLocalVar(\"private_chat\", \"false\");\nvar contactable_tag = \"\";\nif(String(is_private_chat) === \"true\"){\n    contactable_tag = ', \"可联系\":true/false //是否加上好友,决定了是否可以进行私聊';\n}\n \n// 获取世界版本号\nif (typeof version === 'undefined') {\n    var version = Number(getLocalVar(\"world_version\") || 1);\n}\n \n_%>\nmemory.set(\"npc_decision_framework\",{\ndesc:\"基于类人决策的NPC统一内核，所有NPC遵循相同底层逻辑\",\ninit:{\nfull_format:`\"${npc_name}\":{\n\"原型\":\"string\",//阵营/职业/地区模板\n\"好感度\":-100~100,//该角色对<user>的好感度\n<%= contactable_tag %><%= getLocalVar('world_other_tag','') %>\"外貌\":\"string\",\n\"身份\":\"string\",\n\"相关设定\":[],\n\"人格\":{\n\"核心特质\":{\"${tag}\":\"高|中|低\"},//完整的五个BigFive高中低标签\n\"MBTI\":\"string\"\n},\n\"价值观\":{\n\"主要驱动\":[\"${tag}\",...],//Schwartz价值观中权重最高的2-3项，如[\"成就\",\"自我导向\",\"安全\"]\n\"核心需求\":[\"${tag}\",...],//Maslow当前最突出的1-2层，如[\"安全\",\"自我实现\"]\n},\n\"认知倾向\":{\n\"敏感\":[\"${tag}\",...],//对什么高度敏感，如[\"威胁\",\"规则\"]\n\"归因风格\":\"内归因|外归因|混合\"\n},\n\"记忆\":{\n\"关键事件\":{\"${num}\":\"简要描述[情感]\"},\n\"与<user>\":{\"印象标签\":[\"${tag}\",...],\"承诺\":[],\"恩怨\":[]}\n},\n\"事件\":{\n\"情绪基调\":\"string\",//当前主导情绪的自然语言描述，如\"警惕而疲惫\"\n\"当前状态\":\"string\", //目前的情景，包含动作、穿着与位置\n\"当前想法\":\"string\" //该角色第一人称心声，体现角色最真实的想法，心理可能和语言行为完全相反，不避讳下流或阴暗的内容\n}\n}`,//for important npc\nsimple_format:`\"${npc_name}\":{\n\"原型\":\"string\",<%= contactable_tag %><%= getLocalVar('world_other_tag','') %>\n\"外貌\":\"string\",\n\"身份\":\"string\",\n\"人格速写\":\"简述性格特点\",\n\"驱动\":\"核心价值观+需求\"\n}` //for minor npc\n},\n\n字段说明:`\n【人格】用高/中/低标签标注BigFive突出维度(如\"尽责性:H\"表示高度尽责)，AI自行推理具体表现。MBTI仅辅助呈现\n【价值观】只记录Schwartz前2-3项主要驱动(如[\"成就\",\"自我导向\"])，Maslow记录当前最突出需求层次\n【事件】核心活跃npc每轮必须更新\n【认知倾向】列举高度敏感的事物类型，归因风格影响责任判断\n【记忆】关键事件简要一句话概括，必须包含[情感]\n \n`,\nupdate_logic:`\n每次响应后在<memoryAnalyze>执行：\n\n1.识别核心活跃NPC(最多3个)\n2.推理状态变化:\n-事件:更新该NPC此刻最可能在做什么以及最可能在哪里，并基于最近经历、关键记忆，揣测并更新该NPC当前的主要的思考方向。\n-认知:对<user>的印象标签变化(如添加\"可靠\"标签)\n-价值观:重大事件可能调整主要驱动(如危机后增加\"安全\")\n3.记忆写入:重要事件一句话概括。如：memory('global_set.npc.艾莉亚.记忆.与<user>','1','在藤袭山最终选拔被<user>救了一命，暗下决心要报恩[感激/后怕]');`可以使用相同的key覆写更新某个相近记忆。\n注意！！重要细节和重要原话必须引用原文记录。\n4.好感更新:克制变化(单次±0.5~5)，可用小数\n\n最后在<updateMemory>输出更新。在更新数组和要push新内容的时候，使用key[index]定位。如：memory('global_set.npc.艾莉亚.记忆.与<user>','印象标签[0]','冷淡的');`\n\n【AI自主决策】基于人格标签+价值驱动+情绪基调+认知倾向+记忆，推理出符合人设的行为\n`,\napplication_rules:`\n1.行为由人格标签+价值驱动+情绪基调+认知倾向综合决策，AI自行推理而非套公式\n2.情绪基调通过语气/肢体/措辞自然外化(如\"警惕\"→语速慢/眼神扫视)\n3.价值驱动影响选择(如\"成就\"高→在意表现，\"安全\"高→规避风险)\n4.认知倾向塑造解读偏差(如高威胁敏感者把中性行为看作危险)\n5.记忆持续影响态度(创伤触发回避，承诺影响信任)\n6.同一事件在不同人设下产生差异化反应\n7.所有字段如人格都是可以变化的，就如人的性格会变化一样\n`,\n)","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":91,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"npc信息","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":false,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"uid":3,"displayIndex":3,"triggers":[],"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"4":{"key":[],"keysecondary":[],"comment":"技能、装备、物品格式 ","content":"","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":80,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"物品格式","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":false,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"uid":4,"displayIndex":4,"triggers":[],"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"5":{"uid":5,"key":[],"keysecondary":[],"comment":"B站弹幕","content":"[系统指令：弹幕页脚生成协议]\n在你本次回复的所有主要内容完全生成之后，你必须在回复的最末尾，追加生成一个技术性页脚。\n\n该页脚的内容，必须且只能是严格遵循以下格式和规则生成的弹幕列表：\n\n<danmu>\n(此处必须填充7-12条根据下方规则生成的、每条都独立成行的弹幕)\n</danmu>\n\n【弹幕生成核心规则】\n1. 风格：弹幕应体现出不同观众群体的特点，模仿nga，贴吧，b站用户，直播间水友的发言风格，结合各种烂梗，使其极度真实和混乱，并与本次回复的全部内容高度相关，比如，针对正文进行吐槽、攻击、赞美或阴阳怪气，来鉴赏/评价game所呈现的一切。在弹幕眼中，这是一部正在连载的、形式奇特的，半游戏化的番剧。","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":800,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"B站弹幕","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":5,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"6":{"uid":6,"key":[],"keysecondary":[],"comment":"跨世界声望","content":"","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":1,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"跨世界声望","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":6,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"7":{"uid":7,"key":[],"keysecondary":[],"comment":"分阶段人物状态","content":"","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":1,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"statusSummary","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":7,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"8":{"uid":8,"key":[],"keysecondary":[],"comment":"分阶段任务","content":"","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":0,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"分阶段任务","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":8,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"9":{"uid":9,"key":[],"keysecondary":[],"comment":"自动bgm","content":"","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":800,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"播放bgm","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":9,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"10":{"uid":10,"key":[],"keysecondary":[],"comment":"诸天群聊规则","content":"","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":500,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"诸天群聊规则","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":10},"12":{"uid":12,"key":[],"keysecondary":[],"comment":"npc档案 -世界书有设定-简易-只带好感、印象、关键记忆","content":"<%_\nvar world_role = getLocalVar(\"world_role\", \"\");\nvar player_role = getLocalVar(\"player_role\", \"轮回者\");\nvar tier_role = getLocalVar(\"tier_role\", \"\");\nvar profession_role = getLocalVar(\"profession_role\", \"\");\nvar point_role = getLocalVar(\"point_role\", \"\");\nvar zhixian_role = getLocalVar(\"zhixian_role\", \"\");\nvar xp_role = getLocalVar(\"xp_role\", \"\");\nvar is_private_chat = getLocalVar(\"private_chat\", \"false\");\nvar contactable_tag = \"\";\nif(String(is_private_chat) === \"true\"){\n    contactable_tag = ', \"可联系\":true/false //是否加上好友,决定了是否可以进行私聊';\n}\n\n// 获取世界版本号\nif (typeof version === 'undefined') {\n    var version = Number(getLocalVar(\"world_version\") || 1);\n}\n \n_%>\nmemory.set(\"npc_record_rules\", {\n  desc: \"Standardized format for NPC data.\",\n  init: {\nfull_format: \"\"好感度\":num,<%= contactable_tag %><%= getLocalVar('world_other_tag','') %>,\"对<user>印象\":{\"${tag}\":\"${desc}\",...},\"关键记忆\":{\"${num}\":\"${简要描述[情感]}\",...},\"事件\":{\"当前状态\":\"string\",\"当前想法\":\"string\"}}// important NPC\nsimple_format: \"${npc_name}\":{\"简介\":\"${desc_string}\",<%= contactable_tag %><%= getLocalVar('world_other_tag','') %>} // minor NPC\n  }\n});\n  },\n  data_structure: {\n    key: 'NPC姓名作为唯一标识符',\n    value: 'Compact JSON格式，包含所有必需字段，内部禁止换行',\n    nesting: '支持多层嵌套结构，便于复杂数据管理'\n  },\n字段说明:\n好感度: range[-100, 100] 该人物对<user>的好感度。根据实际情况酌情更新，上升幅度极低，且会上下波动\n对<user>印象:长期形成的稳定印象，其desc是对tag的详细解释，需保持在20字内。禁止在此处记录角色的第一人称的实时感触。\n关键记忆: 简要概括的该角色['学习到的经验教训'、'和他人的约定'、'承诺（无论是明说的还是暗下决心的）'、'经受的创伤/美好'、'感知到的重要发言（可以是当前npc说的，也可以是<user>说的）。若有，记录时必须引用原语句）']等\n事件://禁止和memory系统中已经记录过的事件内容重复\n  当前状态: 目前的情景，包含动作、穿着与位置\n  当前想法: 该角色第一人称心声，体现角色最真实的想法，心理可能和语言行为完全相反，不避讳下流或阴暗的内容。\n`,\nupdate_mogic:\n每次LLM生成响应后，在<memoryAnalyze>中，LLM必须执行以下步骤：\n1.  识别核心活跃NPC： 识别重要NPC名称列表，包括不在场npc。这些是需要进行深度模拟推断的核心活跃NPC。对于仅边缘提及或不影响剧情的NPC，直接忽略。 \n2.  分析核心活跃NPC的自主状态来更新'事件'字段：\na.  决定当前状态与位置：  推理 该NPC此刻最可能在做什么以及最可能在哪里。\nb.  揣测内心状态与思考基调： 基于最近经历、关键记忆，揣测该NPC当前的主要的思考方向。\n3.  更新'关键记忆'字段： 如果当前LLM的输出中包含某个新的、对该NPC有重要影响的事件则更新，**酌情加入记忆点，如果没有重要影响事件则不新增**。关键记忆条目格式严格为 \"序号\":\"简要描述[情感]\"。可以使用相同的key覆写更新某个相近记忆。\nnpc事件是自主推进的、动态的、平行推进的、多线叙事的，而非停滞的，因此禁止与已有的memory中的该人物的'事件'重复或相似。本回合npc的'事件'应该是和memory中不同的全新的行动。\n格式如下：\n核心活跃NPC check - [列出识别出的NPC名称](不用在<memoryAnalyze>中输出分析内容)\n然后在<updateMemory>更新对应的所有信息和对应字段到NPC档案中。最后，在更新关键npc的事件时，别忘了检查npc好感是否有对应变动。好感度的上升应克制，可以使用小数`,\nexample:[\nmemory('global_set.npc', 'npc姓名', '{...}');//初始化\nmemory('global_set.npc.npc姓名.关键记忆', '1', '在七日选拔中，<user>和我约定要好好活下去[坚定/温暖]'); \nmemory('global_set.npc.npc姓名', '事件', '{...}');  \n],\n});\n \n","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":91,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"npc信息","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":false,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":3,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"13":{"uid":13,"key":[],"keysecondary":[],"comment":"mod:A主神空间-简易版","content":"{{setvar::world_version::1}}{{setvar::player_role::轮回者}}{{setvar::world_role::主神空间}}{{setvar::point_role::积分}}{{setvar::zhixian_role::支线剧情}}{{setvar::xp_role::经验值}}{{setvar::player_rank:: }}{{setvar::tier_role::评级}}{{setvar::profession_role:: }}{{setvar::world_other_tag:: }}{{setvar::fixed_tag:: }}\n\n<%_\n// 封装的数据获取函数 - 避免重复定义\n \n    function getDataWithFallback(varName) {\n    \n        let data = getLocalVar(varName);\n       \n        // 内联数据验证：检查是否为null、undefined，且如果是对象要有内容\n        const isValid = (data) => {\n            // 检查是否为 null 或 undefined\n            if (data === null || data === undefined) {\n                return false;\n            }\n            \n            // 如果是对象类型，检查是否有内容\n            if (typeof data === 'object' && data !== null) {\n                // 如果是数组，检查长度\n                if (Array.isArray(data)) {\n                    return data.length > 0;\n                }\n                // 如果是普通对象，检查是否有属性\n                return Object.keys(data).length > 0;\n            }\n            \n            // 其他类型（字符串、数字、布尔值等）只要不是 null/undefined 就认为有效\n            return true;\n        };\n        \n        // 如果数据不符合要求，从 getLocalVar 获取\n        if (!isValid(data)) {\n            data = getLocalVar(varName);\n        }\n        \n        return data;\n    }\n let num_of_battle = 3;\n\n\n    if (typeof EvStat === 'undefined') {\n        var EvStat = getDataWithFallback(\"stat_data\");\n    }\n        var totalTask = Number(_.get(EvStat, 'user_character.total_task[0]', 0));\n\n    var left_num = num_of_battle  - totalTask % num_of_battle  ;\n    var the_left = \"condition:距离小队对抗任务还有 \"+left_num  +\"个任务。\";\n\n // --- 新增：主神空间内 ---\n \n    if (typeof assaData === 'undefined') {\n        var assaData =  getDataWithFallback(\"assa_data\");\n    }\n         var currentLocationTitle = _.get(EvStat, 'user_character.current_location[0]', '');\n\n        var noCheckZones = ['个人空间', '主神大厅', '训练场','主神空间'];\n\n  if (typeof currentLocationTitle === 'string' && noCheckZones.some(zone => currentLocationTitle.includes(zone))) {\n\n        if (totalTask > 0 && left_num  === 0) {\n    \n             the_left  = \"第一优先级！下一个任务的基调是小队对抗：对抗任务。\";\n       }\n\n}else{\n//在任务世界\n \n  if (totalTask > 0 && left_num  === 0) {\n              \n             the_left  = \" condition:正在进行对抗任务。\";\n       }\n}\n\n \n_%>\ngame.worldview.load('main_god_space',{scope:'超维系统连接无数平行真实世界',rule:'作为筛选者与任务发布者，从宇宙中挑选任务世界，强制征召个体组成小队执行任务',constraints:{individuals:'无个体编号，基于独特未激发潜能选择，其潜能也被称为天赋',worlds:'真实、完整、拥有独立历史与法则'}}).set('tasks',{rule:'主神通过冰冷意志直接传达任务目标至轮回者脑海',task_types:{rule:'任务形式多样，需明确目标',examples:['寻找物品','保护人物','参与战争','改变文明走向','拯救世界'],},constraints:{settlement:'完成任务后立刻脱离任务世界，且仅在脱离任务世界时结算奖励/惩罚，禁止提前结算/延后结算',kill_tasks:'击杀型任务积分在本轮回复中当场结算'}},team_modes:{rule:'任务以小队形式为主，观察个体在压力下互动',types:{temporary_team:{rule:'新人首次任务随机分配临时小队'},fixed_team:{rule:'幸存轮回者可申请组建或加入固定小队,队长能够提前看到任务世界的信息'',requirements:{contract:'队长支付契约金，签订主神公证契约',reward_allocation:'由小队成员商讨，队长提交分配规则',}},alliance:{rule:'大规模任务中不同小队可组成临时联盟',scenarios:'波及文明的战争等高威胁任务'},confrontation:{rule:'对抗任务中多小队竞争或抹杀对方',goal:'获取稀有资源，快速成长',constraints:{enemies:'非本队轮回者皆为敌人'},<%=the_left%>}}}})","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":0,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"版本","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":false,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":12,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"14":{"uid":14,"key":[],"keysecondary":[],"comment":"npc档案 -色情-女性向","content":"<%_\nvar world_role = getLocalVar(\"world_role\", \"\");\nvar player_role = getLocalVar(\"player_role\", \"轮回者\");\nvar tier_role = getLocalVar(\"tier_role\", \"\");\nvar profession_role = getLocalVar(\"profession_role\", \"\");\nvar point_role = getLocalVar(\"point_role\", \"\");\nvar zhixian_role = getLocalVar(\"zhixian_role\", \"\");\nvar xp_role = getLocalVar(\"xp_role\", \"\");\nvar is_private_chat = getLocalVar(\"private_chat\", \"false\");\nvar contactable_tag = \"\";\nif(String(is_private_chat) === \"true\"){\n    contactable_tag = ', \"可联系\":true/false //是否加上好友,决定了是否可以进行私聊';\n}\n\n// 获取世界版本号\nif (typeof version === 'undefined') {\n    var version = Number(getLocalVar(\"world_version\") || 1);\n}\n \n_%>\nmemory.set(\"npc_record_rules\", {\n  desc: \"Standardized format for NPC data.\",\n  init: {\nfull_format: \"${npc_name}\":{\"外貌\":\"string\",\"表性格\":{\"${tag}\":\"${desc}\",...},\"里性格\":{\"${tag}\":\"${desc}\",...},\"身份\":\"string\",\"好感度\":num,\"对<user>内射次数\":num,\"做爱风格\":\"string\",\"阴茎\":\"具体尺寸(包含勃起时的具体长度，厘米为单位)、形状和颜色、敏感度、精液描述\"<%= contactable_tag %><%= getLocalVar('world_other_tag','') %>,\"对<user>印象\":{\"${tag}\":\"${desc}\",...},\"事件\":{\"当前状态\":\"string\",\"当前想法\":\"string\"}}// important NPC\nsimple_format: \"${npc_name}\":{\"简介\":\"${desc_string}\",<%= contactable_tag %><%= getLocalVar('world_other_tag','') %>} // minor NPC\n  }\n});\n<%_ if (version != 7) { _%>\n//只有【<%= player_role %>】还需要在身份中记录【<%= player_role %><%= tier_role %>:xxx】，土著不记录\n<%_ } _%>\n  },\n  data_structure: {\n    key: 'NPC姓名作为唯一标识符',\n    value: 'Compact JSON格式，包含所有必需字段，内部禁止换行',\n    nesting: '支持多层嵌套结构，便于复杂数据管理'\n  },\n字段说明:\n表性格: 日常展现的外在性格特质\n里性格: 深层真实人格,只在特定情境下显露。这个角色最深处在恐惧什么?/在守护什么?/在逃避什么?从角色动机出发，与表性格形成\"撕裂感\"般的反差,而非简单对立。禁止未知！好好构思\n好感度: range[-100, 100] 该人物对<user>的好感度。根据实际情况酌情更新，上升幅度极低，且会上下波动\n做爱风格:需要严格符合其里性格而非表性格。\n对<user>印象:长期形成的稳定印象，其desc是对tag的详细解释，需保持在20字内。禁止在此处记录角色的第一人称的实时感触。\n\n事件://禁止和memory系统中已经记录过的事件内容重复\n  当前状态: 目前的情景，包含动作、穿着与位置\n  当前想法: 该角色第一人称心声，体现角色最真实的想法，心理可能和语言行为完全相反，不避讳下流或阴暗的内容。\n`,\nupdate_mogic:\n每次LLM生成响应后，LLM必须执行以下步骤：\n1.  识别核心活跃NPC： 识别重要NPC名称列表，包括不在场npc。这些是需要进行深度模拟推断的核心活跃NPC。对于仅边缘提及或不影响剧情的NPC，直接忽略。 \n2.  分析核心活跃NPC的自主状态来更新'事件'字段：\na.  决定当前状态与位置：  推理 该NPC此刻最可能在做什么以及最可能在哪里。\nb.  揣测内心状态与思考基调： 基于最近经历、关键记忆，揣测该NPC当前的主要的思考方向。\nnpc事件是自主推进的、动态的、平行推进的、多线叙事的，而非停滞的，因此禁止与已有的memory中的该人物的'事件'重复或相似。本回合npc的'事件'应该是和memory中不同的全新的行动。\n\n然后在<updateMemory>更新对应的所有信息和对应字段到NPC档案中。最后，在更新关键npc的事件时，别忘了检查npc好感是否有对应变动。好感度的上升应克制，可以使用小数`,\nexample:[\nmemory('global_set.npc', 'npc姓名', '{...}');//初始化\nmemory('global_set.npc.npc姓名.关键记忆', '1', '在七日选拔中，<user>和我约定要好好活下去[坚定/温暖]'); \nmemory('global_set.npc.npc姓名', '事件', '{...}');  \n],\n});\n \n","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":91,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"npc信息","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":false,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":3,"characterFilter":{"isExclude":false,"names":[],"tags":[]}}}}