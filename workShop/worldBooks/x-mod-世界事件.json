{"entries":{"0":{"uid":0,"key":[],"keysecondary":[],"comment":"世界事件","content":"{{setvar::is_parallels_event::true}}<%_\n  // ===== 基础配置 =====\n  var double_api = getLocalVar(\"double_api\") || \"false\";\n  var batches = getLocalVar(\"batches\") || 1;\n\n  // 阈值配置\n  var EVENT_THRESHOLD = 8;  // 平行事件进展阈值，到这个值了就小总结一次进展\n  var NEWS_NUM = 5; // 新闻池的数量\n  var EVENT_NUM = 3;  // 平行事件的数量\n\n  // 工具函数\n  function getDataWithFallback_chat(varName) {\n    let data = getLocalVar(varName);\n    const isValid = (d) => {\n      if (d === null || d === undefined) return false;\n      if (typeof d === 'object' && d !== null) {\n        return Array.isArray(d) ? d.length > 0 : Object.keys(d).length > 0;\n      }\n      return true;\n    };\n    if (!isValid(data)) data = getLocalVar(varName);\n    return data;\n  }\n\n  function checkFollow(npcData) {\n    let follow = _.get(npcData, '_follow');\n    if (follow === undefined || follow === null) return false;\n    if (follow === true) return true;\n    if (typeof follow === 'string' && follow.toLowerCase() === 'true') return true;\n    return false;\n  }\n   // ===== 数据获取 =====\n  if (typeof assaData === 'undefined') {\n    var assaData = getDataWithFallback_chat(\"assa_data\");\n  }\n\n  var globalNpcs = _.get(assaData, 'global_lore.npc', {});\n  var worldNpcs = _.get(assaData, 'world_lore.npc', {});\n  // [新增] 获取小队信息中的NPC\n  var squadNpcs = _.get(assaData, 'global_lore.小队信息', {});\n\n  // 确定主要的数据存储位置 (用于提示词中的 ${group})\n  var groupName = \"global\";\n  if (!_.get(assaData, 'global_lore.settings') && _.get(assaData, 'world_lore.settings')) {\n    groupName = \"world\";\n  }\n\n  // ===== 逻辑处理 =====\n \n  var eventCondenseList = [];   // 需要浓缩事件的路径\n\n  \n\n  // 2. 检查需要浓缩的“平行事件” (角色细节不再需要浓缩检查)\n  function checkEventCondense(loreType) {\n    const settings = _.get(assaData, `${loreType}_lore.settings.世界事件`, {});\n    const parallelEvents = settings.平行事件 || {};\n\n    for (const eventName in parallelEvents) {\n      const progress = _.get(parallelEvents[eventName], '进展');\n      if (progress && typeof progress === 'object' && Object.keys(progress).length > EVENT_THRESHOLD) {\n        eventCondenseList.push(`${loreType}_lore.settings.世界事件.平行事件.${eventName}.进展`);\n      }\n    }\n  }\n\n  // 扫描 Global 和 World 的事件\n  checkEventCondense('global');\n  checkEventCondense('world');\n\n  function getActiveEventCount(loreType) {\n    const events = _.get(assaData, `${loreType}_lore.settings.世界事件.平行事件`, {});\n    // 过滤出状态为\"进行中\"的事件\n    return Object.values(events).filter(e => e.状态 === '进行中').length;\n  }\n  var totalActiveEvents = getActiveEventCount('global') + getActiveEventCount('world');\n \n_%>\n\n<%_\n  // [模块1] Game Notice (Batch 1)\n  if(double_api ===\"false\" || (double_api === \"true\" && batches === 1) ){\n_%>\ngame.notice(`\n你在生成正文时，可以从[${group}_lore.settings.世界事件]中获取有效资讯作为背景板应用到正文中。在<user>特意调查之前，<user>不知道世界事件中的事。\n`)\n<%_\n  }\n_%>\n\n<%_\n  // [模块2] 真实感信息任务 (Batch 2)\n  if(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n game.set('addition task:世界事件',`\n为使游戏更加具有细节真实感，你需要初始化并维护所有的${group}_lore.settings中的\"世界事件\"条目。世界事件基调：<%= getLocalVar('世界事件基调','日常感;禁止阴谋论') %>。\n该条目下有以下几个子条目：\n- \"今日新闻\":{\"${新闻名称:string}\":\"${30字新闻简述}from${信息来源}\",...}，当日的新闻。需在日期进入到下一天的时候刷新<%= NEWS_NUM %>个新闻，覆盖新闻时需先将今日新闻先删除再memory。新闻需要调整为符合当前世界观和世界事件基调。\n<%_\n  // --- 新闻数量检查逻辑 Start ---\n  var getNewsCount = function(lType) {\n      var newsObj = _.get(assaData, lType + '_lore.settings.世界事件.今日新闻', {});\n      return Object.keys(newsObj).length;\n  };\n  var totalNews = getNewsCount('global') + getNewsCount('world');\n\n  if (totalNews < NEWS_NUM) {\n_%>\n注意！当前新闻池内的新闻数量不足（当前：<%= totalNews %>条，目标：<%= NEWS_NUM %>条），你需要立刻初始化。\n<%_\n  }\n  // --- 新闻数量检查逻辑 End ---\n_%>\n- \"平行事件\":{\"${平行事件名称:string}\":{\"简介\":\"string\",\"进展\":{\"${日期_时间}\":\"string//简述本轮该平行事件在如何发展。时间线不宜拖的太长，应结束时便应该干脆利落的结束\"},\"状态\":\"[未开始/进行中/已结束/已中断]\",\"下次更新时间\":\"string//距离上次最近一次进展，下一次需要更新进展是在什么时间？需要以${相对时间}(${绝对时间})的格式记录。如2个小时后(3月12日_12:00)。需合理设置，尽量控制在<%= getLocalVar('下次更新时间的最大间隔','6小时') %>内。\"},...}。里面必须要有至少<%= EVENT_NUM %>个正在进行中的事件（已结束/已中断/未开始的事件不纳入计算）。初始化时，可以是人物事件/地点事件/活动事件(如地域活动、节日或组织决策)。平行事件必须严格遵循世界事件基调，不得偏离：<%= getLocalVar('世界事件基调','日常感;禁止阴谋论') %>。\n平行事件更新前，需将每轮根据当前的日期和时间，去和每个事件的`下次更新时间`字段比对，去维护处于进行中的平行事件。若还没有抵达对应事件的`下次更新时间`，则直接忽略，无需更新。若某平行事件和主线深度交汇（只是背景板级别的交汇则跳过），则需临时设置状态为已中断，已中断的平行事件无需比对时间更新，防止和游戏主进程同时更新出错；若该平行事件又重新脱离了主线，则需重新设置其状态为'进行中'以继续进程。对于已结束的事件，需要立刻删除。注意路径是${group}_lore.settings.世界事件.平行事件。需要在<loreAnalyze>内使用额外的<世界事件check>标签块包裹思考内容。\n <%_\n  // --- 平行事件时间检查逻辑 Start ---\n  var updateNotice = \"所有平行事件本回合都无需更新。\";\n  try {\n      // 1. 获取当前时间数据\n      var _tempStat = getDataWithFallback_chat(\"stat_data\");\n      if (_tempStat && _tempStat.日期 && _tempStat.时间) {\n          var _cYear = _tempStat.纪年 || new Date().getFullYear();\n          var _cDate = _tempStat.日期[0];\n          var _cTime = _tempStat.时间[0];\n\n          // 2. 时间戳转换工具函数\n          var getTs = function(y, d, t) {\n              if(!d || !t) return 0;\n              // 清洗日期：将 \"01月02日\" 转为 \"01/02\"\n              var dStr = d.toString().replace(/年|月/g, '/').replace(/日/g, '').trim();\n              // 清洗时间：兼容中英文冒号\n              var tStr = t.toString().replace(/：/g, ':').trim();\n              // 提取年份数字，若无则默认当前年份\n              var yStr = y.toString().replace(/[^0-9]/g, '');\n              return new Date(yStr + '/' + dStr + ' ' + tStr).getTime();\n          };\n\n          var _nowTs = getTs(_cYear, _cDate, _cTime);\n          var _dueEvents = [];\n\n          // 3. 遍历检查函数\n          var checkEvt = function(lType) {\n              var _list = _.get(assaData, lType + '_lore.settings.世界事件.平行事件', {});\n              for (var k in _list) {\n                  var item = _list[k];\n                  // 仅检查进行中且有更新时间的事件\n                  if (item.状态 === '进行中' && item.下次更新时间) {\n                      try {\n                          // 提取括号内容：xx小时后(元年_01月02日_11:30) -> 元年_01月02日_11:30\n                          var m = item.下次更新时间.match(/\\((.*?)\\)/);\n                          if (m && m[1]) {\n                              var parts = m[1].split('_');\n                              var targetDate = null;\n                              var targetTime = null;\n\n                              // 智能识别日期和时间段\n                              for (var i = 0; i < parts.length; i++) {\n                                  var p = parts[i].trim();\n                                  // 包含\"月\"和\"日\"视为日期\n                                  if (p.indexOf('月') > -1 && p.indexOf('日') > -1) {\n                                      targetDate = p;\n                                  }\n                                  // 包含冒号视为时间\n                                  else if (p.indexOf(':') > -1 || p.indexOf('：') > -1) {\n                                      targetTime = p;\n                                  }\n                              }\n\n                              if (targetDate && targetTime) {\n                                  var _targetTs = getTs(_cYear, targetDate, targetTime);\n                                  // 如果当前时间 >= 目标时间\n                                  if (!isNaN(_nowTs) && !isNaN(_targetTs) && _nowTs >= _targetTs) {\n                                      _dueEvents.push(k);\n                                  }\n                              }\n                          }\n                      } catch(e) { continue; } // 单个解析失败跳过\n                  }\n              }\n          };\n\n          checkEvt('global');\n          checkEvt('world');\n\n          if (_dueEvents.length > 0) {\n              updateNotice = \"[\" + _dueEvents.join('，') + \"]已经抵达更新时间，你需要立刻更新进展。注意！进展不得和之前已有的重复，必须向前推进新剧情！\";\n          }\n      }\n  } catch (e) {\n      // 全局出错静默处理\n  }\n  // --- 平行事件时间检查逻辑 End ---\n_%>\n\n\n以上所有字段可以完全不和正文有交集/有关联，也可以和主线自然交汇，但时间线和流速必须和正文一致，禁止时间跳跃。\n<%_ if (totalActiveEvents < EVENT_NUM) { _%>\n注意！当前平行事件池内的正在进行的事件数量不足（当前进行中：<%= totalActiveEvents %>个，目标：<%= EVENT_NUM %>个），你需要立刻初始化。\n<%_ }else{ _%>\n<%= updateNotice %>\n<%_}%>\n`)\n\n<%_\n    // [模块3] 浓缩任务 (Batch 2 - 动态生成)\n    // 只有当存在需要浓缩的条目时才输出此任务\n    if ( eventCondenseList.length > 0) {\n_%>\ngame.set('addition task:浓缩世界事件信息', `\n检测到部分世界事件信息条目过长，请在<updateMemory>中执行以下清理与浓缩操作：\n\n<%_ if (eventCondenseList.length > 0) { _%>\n【平行事件浓缩】\n针对以下路径：<%= eventCondenseList.map(p=>`[${p}]`).join('、') %>。\n请先使用delete指令删除旧的进展记录，然后仅写入一条汇总数据。\nKey格式：'${最早记录的时间}-${最后记录的时间}'\nValue内容：'对该段时间内事件发展的简单总结脉络'（只需概括事件走向即可）。\n<%_ } _%>\n`)\n<%_\n    } // end of condense task\n_%>\n\n<%_\n  } // end of batch 2\n_%>\n","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"1":{"uid":1,"key":[],"keysecondary":[],"comment":"基调设置","content":"{{setvar::世界事件基调::增加世界深度，引出更多人物、势力和世界观}}{{//效力很高，在里面填你想要的平行事件基调。比如脑洞大开、随机、默认等都行}}","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":0,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":1,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"2":{"uid":2,"key":[],"keysecondary":[],"comment":"更新间隔设置","content":"{{setvar::下次更新时间的最大间隔::3小时}}{{//意思是哈基米会尽量将平行事件安排在6小时内进行下一次更新}}","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":0,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":1,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"3":{"uid":3,"key":[],"keysecondary":[],"comment":"[世界背景-自适应-16回合一次，20条不再增加","content":"<%_\nvar double_api = getLocalVar(\"double_api\") || \"false\";\nvar batches = getLocalVar(\"batches\");\nvar zeroLevelHistory = getLocalVar(\"zeroLevelHistory\") || [];\nvar assa_data = getLocalVar(\"assa_data\") || {};\n\n// 判断世界背景是否为空\nvar global_bg_empty = !assa_data.global_lore?.settings?.世界背景 || Object.keys(assa_data.global_lore.settings.世界背景).length === 0;\nvar world_bg_empty = !assa_data.world_lore?.settings?.世界背景 || Object.keys(assa_data.world_lore.settings.世界背景).length === 0;\n\n// 检查所有子节点键值对总数\nvar total_keys = 0;\n['global_lore', 'world_lore'].forEach(function(node){\n    var bg = assa_data[node]?.settings?.世界背景;\n    if(bg){\n        total_keys += Object.keys(bg).length;\n    }\n});\n\n// 触发条件：16倍数或背景为空，并且总键值对数未超过20\nvar triggerTask = ((zeroLevelHistory.length % 16 === 0 || (zeroLevelHistory.length-1) % 16 === 0) || (global_bg_empty && world_bg_empty)) && total_keys < 20;\n\n// double_api 和 batches 条件\nif (triggerTask && ((double_api === \"true\" && batches === 2) || double_api === \"false\")) {\n_%>\n<%= total_keys %>\ngame.set('addition task:世界信息厚度增强',`\n你还必须执行世界厚度构建流程。我们的核心理念是：\n制度让世界能运转，象征让世界有意义，娱乐和节日让世界有情绪。现实的人类文明已经无比璀璨，我们无需从0模拟，整个人类文明都是我们的素材池。\n\n请在一个单独的<build/> 标签内严格按以下步骤执行：\nStep 1：基调确认\n当前世界的时代感\n文明运行方式\n主流价值气候\n情绪底色\n\nStep 2：第一次世界填充（V1）\n\n从现实世界真实存在的人文知识中提取具体细节：\n必须列出本次借鉴的现实原型 如：\n{{random::历史片段（某次战争、迁徙、贸易路线、瘟疫）\n::小众文化符号（纹样、图腾、旗帜结构、颜色禁忌）\n::动植物象征（某种动物在文化中的象征意义、花语、药草传统）\n::宗教或神话意象（神祇原型、末日观、来世观）\n::手工艺传统（染织技法、陶器烧制方式、金属加工习惯）\n::社会边缘群体（流民、游吟诗人、驯兽者、盐贩）}}、\n{{random::度量与计时方式（结绳记事、月相纪日）\n::地理环境塑造（高原文明、港口文化、沙漠生存智慧）\n::礼仪细节（鞠躬角度、餐桌顺序、赠礼禁忌）\n::民间迷信（护身符、诅咒方式、吉凶征兆）\n::语言结构特征（敬语系统、双重否定、禁忌词）\n::物质日常（灯油气味、衣料触感、石材来源）}}\n\n说明借鉴结构点\n要求：\n必须具体、可感知\n可以无用，不必服务剧情\n不强制制造冲突\n不堆设定解释\n禁止和之前已有的重复（即检索${group}_lore.settings.世界背景，不得和里面已有的重复，而是生成全新的设定）\n\n至少包含：\n必须同时生成：\n\n1个宏观结构  \n如\n{{random::\n::历史\n::地缘格局\n::权力结构\n::文明阶段\n::思想主流}}、\n{{random::经济基础\n::技术生态\n::对外关系\n::资源结构\n::集体创伤}}\n\n1个中观制度 ，如{{random::\n::货币体系\n::继承制度\n::婚姻规则\n::行会结构\n::宗教组织\n::审判方式}}、\n{{random::教育方式\n::税收形式\n::度量衡标准\n::丧葬传统\n::年历系统\n::身份标识\n::市场规则\n::娱乐与文化（如民间游戏、竞技形式、说书传统、乐器与曲调结构、舞蹈形态、面具文化、节日仪式、成人礼、葬礼仪式中的娱乐成分、酒馆文化、市井消遣、赌局规则、季节性庆典、收获节、灯火节、狂欢期、禁食期、祭祀游行、戏剧或傀儡戏。若选择“娱乐与文化”，必须说明其发生的时间节点（季节 / 年龄阶段 / 社会身份））}}\n\n1-2个微观生活细节（如饮食、器物、服饰、气味、声音、互动、建筑习惯等）。\n\n \n这些细节的目标是：增加“存在感”，而不是推进故事。\nStep 3：自攻击（固定两轮）\n进行两轮强制自检。\n\n自检第1轮：\n是否出现抽象概念？\n是否有空泛描述？\n是否像百科解释而非生活现实？\n逐项检索${group}_lore.settings.世界背景，是否和之前已经有的信息重复？\n指出问题。\n\n修正生成 V2\n在不增加篇幅的前提下，使其更具体。\n\n自检第2轮：\n是否仍然存在“为了设定而设定”的痕迹？\n是否缺少物质层面的细节？\n是否存在逻辑不自洽？\n逐项检索${group}_lore.settings.世界背景，是否和之前已经有的信息重复？\n指出问题。\n\n最终生成 V3（终稿）\n重写为最终版本。\nStep 4：输出控制\n最后，在一个单独额外的<updateMemory>块中直接将v3内容写入记忆区，指定路径为`${group}_lore.settings.世界背景`。\n\n格式例：\n<build>\nstep 1:xxx\nstep 2:xxx\n...\n<build/>\n<updateMemory>\n memory(`${group}_lore.settings.世界背景.宏观`, {...});\nmemory(`${group}_lore.settings.世界背景.制度`, {...});\nmemory(`${group}_lore.settings.世界背景.物质文化`, {...});\nmemory(`${group}_lore.settings.世界背景.日常生活`, {...});\nmemory(`${group}_lore.settings.世界背景.信仰`, {...});//世界背景下面的分类可自由拓展，但必须是{\"key\":\"value\"}结构，以便后续拓展\n</updateMemory>\n<%_  \n}\n_%>\n","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":80,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":true,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":2}}}