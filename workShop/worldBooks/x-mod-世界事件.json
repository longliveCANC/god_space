{"entries":{"0":{"uid":0,"key":[],"keysecondary":[],"comment":"世界事件","content":"{{setvar::is_parallels_event::true}}<%_\n  // ===== 基础配置 =====\n  var double_api = getLocalVar(\"double_api\") || \"false\";\n  var batches = getLocalVar(\"batches\") || 1;\n\n  // 阈值配置\n  const DETAIL_THRESHOLD = 12; // 角色细节条目阈值\n  const EVENT_THRESHOLD = 15;  // 平行事件进展阈值\n \n  const NEWS_NUM = 5; // 新闻池的数量\n  const EVENT_NUM = 3;  // 平行事件的数量\n\n  // 工具函数\n  function getDataWithFallback_chat(varName) {\n    let data = getLocalVar(varName);\n    const isValid = (d) => {\n      if (d === null || d === undefined) return false;\n      if (typeof d === 'object' && d !== null) {\n        return Array.isArray(d) ? d.length > 0 : Object.keys(d).length > 0;\n      }\n      return true;\n    };\n    if (!isValid(data)) data = getLocalVar(varName);\n    return data;\n  }\n\n  function checkFollow(npcData) {\n    let follow = _.get(npcData, '_follow');\n    if (follow === undefined || follow === null) return false;\n    if (follow === true) return true;\n    if (typeof follow === 'string' && follow.toLowerCase() === 'true') return true;\n    return false;\n  }\n   // ===== 数据获取 =====\n  if (typeof assaData === 'undefined') {\n    var assaData = getDataWithFallback_chat(\"assa_data\");\n  }\n\n  var globalNpcs = _.get(assaData, 'global_lore.npc', {});\n  var worldNpcs = _.get(assaData, 'world_lore.npc', {});\n  // [新增] 获取小队信息中的NPC\n  var squadNpcs = _.get(assaData, 'global_lore.小队信息', {});\n\n  // 确定主要的数据存储位置 (用于提示词中的 ${group})\n  var groupName = \"global\";\n  if (!_.get(assaData, 'global_lore.settings') && _.get(assaData, 'world_lore.settings')) {\n    groupName = \"world\";\n  }\n\n  // ===== 逻辑处理 =====\n \n  var eventCondenseList = [];   // 需要浓缩事件的路径\n\n  \n\n  // 2. 检查需要浓缩的“平行事件” (角色细节不再需要浓缩检查)\n  function checkEventCondense(loreType) {\n    const settings = _.get(assaData, `${loreType}_lore.settings.世界事件`, {});\n    const parallelEvents = settings.平行事件 || {};\n\n    for (const eventName in parallelEvents) {\n      const progress = _.get(parallelEvents[eventName], '进展');\n      if (progress && typeof progress === 'object' && Object.keys(progress).length > EVENT_THRESHOLD) {\n        eventCondenseList.push(`${loreType}_lore.settings.世界事件.平行事件.${eventName}.进展`);\n      }\n    }\n  }\n\n  // 扫描 Global 和 World 的事件\n  checkEventCondense('global');\n  checkEventCondense('world');\n\n \n \n_%>\n\n<%_\n  // [模块1] Game Notice (Batch 1)\n  if(double_api ===\"false\" || (double_api === \"true\" && batches === 1) ){\n_%>\ngame.notice(`\n你在生成正文时，可以从[${group}_lore.settings.世界事件]中获取有效资讯并应用到正文中。\n`)\n<%_\n  }\n_%>\n\n<%_\n  // [模块2] 真实感信息任务 (Batch 2)\n  if(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n game.set('addition task:真实感信息',`\n你还需要为游戏内的世界进行真实感信息的补充。你需要初始化并维护所有的${group}_lore.settings中的\"世界事件\"条目。该条目下有以下几个子条目：\n<%_ /* [修改] 只有当存在未达阈值的NPC时，才显示角色细节任务 */ _%>\n\n- \"今日本地新闻\":{}，当日的本地新闻。需在日期进入到下一天的时候刷新<%= NEWS_NUM %>个新闻，每条新闻的数据结构是${新闻名称:string}:${30字新闻简述}from${信息来源}，需符合当前世界的世界观。\n- \"平行事件\":{}，平行事件池。里面必须要有至少<%= EVENT_NUM %>个正在进行中的事件（已结束/已汇入/未开始的事件不纳入计算）。每轮根据当前的status.日期和status.时间，去和每个事件的\"下次更新时间\"比对，去维护处于进行中的平行事件，若还没有抵达更新时间则直接忽略，无需更新。初始化时，可以是人物事件/地点事件/活动事件(如地域活动或组织决策)。每个平行事件的数据结构是${平行事件名称:string}:{\"简介\":\"string\",\"进展\":{\"${日期_时间}\":\"string//简述本轮该平行事件在如何发展。时间线不宜拖的太长，应结束时便应该干脆利落的结束\"},\"状态\":\"[未开始/进行中/已结束/已汇入]\",\"下次更新时间\":\"string//距离上次最近一次进展，下一次需要更新进展是在什么时间？需要以${相对时间}(${绝对时间})的格式记录。如6个小时后(3月12日_12:00)\"}。\n\n以上所有字段可以完全不和正文有交集/有关联，也可以和主线自然交汇，但时间线和流速必须和正文一致，禁止时间跳跃。当某平行事件汇入主线，开始在正文讲述后，则需**立刻**设置状态为已汇入，并将下次更行事件置空，视为中断，停止追踪，以防止平行事件重复更新游戏出错\n\n你需要在进行以上任务之前，在loreanalyze内部进行简单的自由分析和思考：你要如何去做这项任务，并保证不违背认知屏障规则和时间线一致规则。且在进行更新之前，需要检测是否有冗余条目/过时条目需要删除。若有，则需要先删除再更新。\n`)\n\n<%_\n    // [模块3] 浓缩任务 (Batch 2 - 动态生成)\n    // 只有当存在需要浓缩的条目时才输出此任务\n    if ( eventCondenseList.length > 0) {\n_%>\ngame.set('addition task:浓缩世界事件信息', `\n检测到部分世界事件信息条目过长，请在<updateMemory>中执行以下清理与浓缩操作：\n\n<%_ if (eventCondenseList.length > 0) { _%>\n【平行事件浓缩】\n针对以下路径：<%= eventCondenseList.map(p=>`[${p}]`).join('、') %>。\n请先使用delete指令删除旧的进展记录，然后仅写入一条汇总数据。\nKey格式：'${最早记录的时间}-${最后记录的时间}'\nValue内容：'对该段时间内事件发展的简单总结脉络'（只需概括事件走向即可）。\n<%_ } _%>\n`)\n<%_\n    } // end of condense task\n_%>\n\n<%_\n  } // end of batch 2\n_%>\n","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0}}}