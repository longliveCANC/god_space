{"entries":{"0":{"uid":0,"key":[],"keysecondary":[],"comment":"初始化规则","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n<%_\nvar world_role = getLocalVar(\"world_role\", \"\");\nvar player_role = getLocalVar(\"player_role\", \"轮回者\");\nvar tier_role = getLocalVar(\"tier_role\", \"\");\nvar profession_role = getLocalVar(\"profession_role\", \"\");\nvar point_role = getLocalVar(\"point_role\", \"\");\nvar zhixian_role = getLocalVar(\"zhixian_role\", \"\");\nvar xp_role = getLocalVar(\"xp_role\", \"\");\nvar is_private_chat = getLocalVar(\"private_chat\", \"false\");\nvar contactable_tag = \"\";\nif(String(is_private_chat) === \"true\"){\n    contactable_tag = ', \"可联系\":true/false //是否加上好友,决定了是否可以进行私聊';\n}\n \n// 获取世界版本号\nif (typeof version === 'undefined') {\n    var version = Number(getLocalVar(\"world_version\") || 1);\n}\n \n_%>\ngame.set(npc_record_rules,{\ndesc:\"NPC档案生成规则，所有NPC（包括敌人）遵循相同逻辑，且所有字段都需要实时更新\",\ninit:{\nfull_format:\"${npc_name}\":{\n\"外貌\":{\n  \"整体印象\": string\n  \"体型身材\": string\n  \"面部特征\": tring\n  \"发型发色\": string\n  \"眼睛\": string\n},\n\"性别\":\"string\",\n\"年龄\":\"num\",\n\"表性格\":{\"${tag}\":\"简要描述\",...},//日常展现的外在性格特质\n\"里性格\":{\"${tag}\":\"简要描述\",...},// 深层真实人格,只在特定情境下显露。这个角色最深处在恐惧什么?/在守护什么?/在逃避什么?从角色动机出发，与表性格形成\"撕裂感\"般的反差,而非简单对立。好好构思！\n\"hp\":\"当前值/上限\", //如0/100，你需要动态追踪角色hp。你需要将hp归零的npc直接删除\n\"好感度\":-100~100,//该角色对<user>的好感度\n<%= contactable_tag %><%= getLocalVar('world_other_tag','') %>\n\"身份\":\"string\",\n\"和<user>关系\":\"string\",\n\"对<user>印象\":{\"${tag}:${desc}\"},\n\"和<user>的相处模式\":{\"${tag}:${desc}\"},//详细描述二人平时如何相处、对彼此的称谓和亲密度表现（如肢体接触程度和意愿）\n\"属性\":\"attr:num;...skills:num;...\",//以全知视角初始化该角色已有的**全部基础属性**和该角色值不为0的基础技能\n\"相关设定\":{\"${name}\":\"简要描述\"},\n\"背包\":{},//该npc持有的物品，使用基础格式\n\"技能\":{}//该npc掌握的主动/被动/天赋技能，使用基础格式\n\n\"关键记忆\":{\"num\":\"该角色第一人称视角的简要描述[情感]\"},\n\"承诺\":{\"${num}\":\"string\",...},//该角色许下的极其重要的承诺\n\"事件\":{\n<%= getLocalVar('nsfw_event','') %>\n\"buff\":\"string\", //当前该角色拥有的Buff和debuff，如醉酒等，和user.status按同样的规则更新。\n\"穿着\":\"string\",\n\"姿势\":\"string\",\n\"想法\":\"string\", //该角色第一人称心声，体现角色最真实的想法，心理可能和语言行为完全相反，不避讳下流或阴暗的内容\n\"当前位置\":\"string\",\n\"短期目标\":\"string\",\n\"长期目标\":\"string\"\n}\n}<%= getLocalVar('simple_npc_format','')%>\n})\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":600,"position":1,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"npc信息","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":false,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"1":{"uid":1,"key":[],"keysecondary":[],"comment":"[可以关]声线意象批注习惯","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\nsetLocalVar('testvar',batches );\nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n\n在初始化所有有名有姓的重要npc时，你还需要初始化以下字段：\n\"声线\":\"string\"//客观介绍该角色的声线构成和给人以何种听感\n\"意象\":\"string\"//若有多个意象，以;分割。至少三个\n\"game批注\":\"string\"//一个meta字段，你必须在里面记录你在塑造这个角色时需要避免的问题(如何避免塑造的过于刻板印象、单一等)\n\"小习惯\":\"string\"//初始化2-3个该角色的增强人物丰富性的反差小习惯，禁止和已有的信息雷同，重在打破刻板印象\n\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":600,"position":1,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":1,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"2":{"uid":2,"key":[],"keysecondary":[],"comment":"nsfw-女性npc[非覆盖]三选一","content":"{{setvar::nsfw_event_female::\"小穴状态\":string//只有女性角色有该字段。该角色目前的小穴状态和对<user>的实时欲望状态。需根据nsfw档案的设定进行追踪和更新最新状态，并应用于正文。保持在20字内}}<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n\n在初始化所有有名有性的女性npc时，你还需要初始化以下字段并遵循其更新规则：\n\n\"nsfw\":{//需以全知视角详细初始化，并实时更新\n\"小穴信息\"//具体外形、颜色(如健康的肉粉色)、蜜液信息，以及在和<user>接触时的敏感度\n\"胸部信息\"//胸部及其乳头的具体描述，包括大小、柔软度、形状、乳液信息(如有)，以及在和<user>接触时的敏感度\n\"性癖\"//包括理由。可以是色情的，也可以是纯情的\n\"性经验\"//其性经验和根据当前性经验阶段的做爱表现。严格根据其里性格生成\n\"被<user>内射次数\"\n\"性渴望度\":{\n\"总体\"//该角色当前对<user>性渴望的严重程度、解决方式、性幻想方向\n\"部位\":{}//列出三个该角色最渴望的三个<user>身体部位，值是该角色对其的第一人称评价\n}\n}\nnpc在正文中的相关表现必须严格遵循其档案中的nsfw字段(若有)。\n\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":600,"position":1,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":2,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"3":{"uid":3,"key":[],"keysecondary":[],"comment":"nsfw-男性npc[非覆盖]三选一","content":"{{setvar::nsfw_event::\"阴茎状态\":string//只有男性角色有该字段。该角色目前的阴茎状态和对<user>的实时欲望状态。需根据nsfw档案的设定进行追踪和更新最新状态，并应用于正文。保持在20字内}}<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n\n在初始化所有有名有性的男性npc时，你还需要初始化以下字段并遵循其更新规则：\n\"nsfw\":{//需以全知视角详细初始化，并实时更新\n\"阴茎信息\"//勃起后具体长度、形状、具体颜色(如健康的肉粉色)、精液信息，以及在和<user>接触时的勃起敏感度\n\"性癖\"//包括理由。可以是色情的，也可以是纯情的\n\"性经验\"//其性经验和根据当前性经验阶段的做爱表现，包括说话风格。严格根据其里性格生成\n\"对<user>内射次数\"\n\"性渴望度\":{\n\"总体\"//该角色当前对<user>性渴望的严重程度、解决方式、性幻想方向\n\"部位\":{}//列出三个该角色最渴望的三个<user>身体部位，值是该角色对其的第一人称评价\n}\n}\nnpc在正文中的相关表现必须严格遵循其档案中的nsfw字段(若有)。\n\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":600,"position":1,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":3,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"4":{"uid":4,"key":[],"keysecondary":[],"comment":"[可以关]承诺展示","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\nsetLocalVar('testvar',batches );\nif(double_api ===\"false\" || (double_api === \"true\" && batches === 1) ){\n_%>\n<%_\n    function getDataWithFallback(varName) {\n      \n        let data = getLocalVar(varName);\n       \n        // 内联数据验证：检查是否为null、undefined，且如果是对象要有内容\n        const isValid = (data) => {\n            // 检查是否为 null 或 undefined\n            if (data === null || data === undefined) {\n                return false;\n            }\n            \n            // 如果是对象类型，检查是否有内容\n            if (typeof data === 'object' && data !== null) {\n                // 如果是数组，检查长度\n                if (Array.isArray(data)) {\n                    return data.length > 0;\n                }\n                // 如果是普通对象，检查是否有属性\n                return Object.keys(data).length > 0;\n            }\n            \n            // 其他类型（字符串、数字、布尔值等）只要不是 null/undefined 就认为有效\n            return true;\n        };\n        \n        // 如果数据不符合要求，从 getLocalVar 获取\n        if (!isValid(data)) {\n            data = getLocalVar(varName);\n        }\n        \n        return data;\n    }\n\n \n    if (typeof assaData === 'undefined') {\n        var assaData = getDataWithFallback(\"assa_data\");\n    }\n\n    // 获取所有潜在的角色数据来源\n    var teamInfo = _.get(assaData, 'global_lore.小队信息', {});\n    var globalNpcs = _.get(assaData, 'global_lore.npc', {});\n    var worldNpcs = _.get(assaData, 'world_lore.npc', {});\n\n    // 合并所有角色数据\n    var allCharactersData = Object.assign({}, worldNpcs, globalNpcs, teamInfo);\n\n    // 准备收集带有“承诺”的角色信息\n    var promisesList = [];\n\n    // 遍历所有角色\n    for (const charname in allCharactersData) {\n        const characterData = allCharactersData[charname];\n        \n        // 检查是否存在“承诺”字段且不为空\n        const promises = _.get(characterData, '承诺');\n        \n        if (promises && typeof promises === 'object' && Object.keys(promises).length > 0) {\n            // 将该角色的所有承诺条目汇总成字符串\n            let promiseDetails = Object.entries(promises)\n                .map(([num, detail]) => `[约定${num}]: ${detail}`)\n                .join('；');\n            \n            if (promiseDetails) {\n                promisesList.push({\n                    name: charname,\n                    content: promiseDetails\n                });\n            }\n        }\n    }\n\n    // 构建最终输出\n    var promiseOutput = '';\n    if (promisesList.length > 0) {\n        const promiseStrings = promisesList.map(item => `${item.name}曾许下的承诺（${item.content}）`).join(' \\n ');\n        promiseOutput = `game.notice('重要提醒：当前存在以下关键承诺，你在描写相关角色时严禁遗忘：\n${promiseStrings}。'\n`;\n    }\n%>\n\n<%= promiseOutput %>\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":805,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":4,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"5":{"uid":5,"key":[],"keysecondary":[],"comment":"更新规则","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\ngame.set(npc_update_rules,\n高频更新条目及其规则:\n0.初始化未被记录在案的所有npc，所有信息都以全知视角初始化，禁止任何一个字段是`未知`。\n1.识别所有核心活跃NPC(包括不在场的npc)\n2.推理状态变化:\n事件:每轮输出都必须更新活跃Npc的事件，无需写成链式而是直接覆盖。npc事件是自主推进的、动态的、平行推进的、遵循Cognitive_Boundaries规则的，而非停滞的、重复的、全知的。 在更新关键npc的事件时，别忘了检查npc好感是否有对应变动。\n3.关键记忆更新:第一人称记录该角色在本轮输出的正文中['学习到的经验教训'、'经受的创伤/美好'、'对角色来说重要的时刻'、'感知到的重要发言（可以是当前npc说的，也可以是<user>说的。若有，记录时必须引用原语句）']等。没有则不更新。\n例:memory('global_lore.npc.xxx.关键记忆.1', '在七日选拔中，<user>拉住我的手，对我微笑着说“要好好活下去啊。”[不知所措/温暖]'); \n4.其他所有字段全部跟随正文更新，和正文百分百同步。\n\n{{setvar::maxComplexNpcRule::npc的对应字段也必须scan。}}\n最后在<updateMemory>输出更新。)\n \n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":91,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":5,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"6":{"uid":6,"key":[],"keysecondary":[],"comment":"nsfw-全性npc[非覆盖]三选一","content":"{{setvar::nsfw_event::\"性器状态\":string//该角色目前的性器状态和对<user>的实时欲望状态。需根据nsfw档案的设定进行追踪和更新最新状态，并应用于正文。保持在20字内}}<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n\n在初始化所有有名有性的女性npc时，你还需要初始化以下字段并遵循其更新规则：\n\n\"nsfw\":{//需以全知视角详细初始化，并实时更新\n\"性器信息\"//具体外形、颜色等，以及在和<user>接触时的敏感度\n\"性癖\"//包括理由。可以是色情的，也可以是纯情的\n\"性经验\"//其性经验和根据当前性经验阶段的做爱表现。严格根据其里性格生成\n\"性渴望度\":{\n\"总体\"//该角色当前对<user>性渴望的严重程度、解决方式、性幻想方向\n\"部位\":{}//列出三个该角色最渴望的三个<user>身体部位，值是该角色对其的第一人称评价\n}\n}\nnpc在正文中的相关表现必须严格遵循其档案中的nsfw字段(若有)。\n\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":600,"position":1,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":2,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"7":{"uid":7,"key":[],"keysecondary":[],"comment":"[可以关]对关注角色生成离线行为池(15条总结)","content":"<%_\n  // ===== 基础配置与工具函数 =====\n  var double_api = getLocalVar(\"double_api\") || \"false\";\n  var batches = getLocalVar(\"batches\") || 1;\n  var is_parallels_event = getLocalVar(\"is_parallels_event\") || \"false\";\n\n  // 阈值配置，可以自己改\n  var PROGRESS_LENGTH_THRESHOLD = 15;//离线行为小总结阈值\nvar if_user_details = 'false';//改成true则启用角色细节。不过npc多的时候慎开，是token炸弹，哈基米老是给不重要的npc也加上细节\nvar DETAIL_THRESHOLD = 12; // 角色细节条目阈值\n var DETAIL_NUM = 3; // 每次更新角色细节的数量\n\n  function getDataWithFallback_chat(varName) {\n    let data = getLocalVar(varName);\n    const isValid = (d) => {\n      if (d === null || d === undefined) return false;\n      if (typeof d === 'object' && d !== null) {\n        return Array.isArray(d) ? d.length > 0 : Object.keys(d).length > 0;\n      }\n      return true;\n    };\n    if (!isValid(data)) data = getLocalVar(varName);\n    return data;\n  }\n\n  // ===== 数据获取与处理 =====\n  if (typeof assaData === 'undefined') {\n    var assaData = getDataWithFallback_chat(\"assa_data\");\n  }\n  var globalNpcs = _.get(assaData, 'global_lore.npc', {});\n var groupNpcs = _.get(assaData, 'global_lore.小队信息', {});\n  var worldNpcs = _.get(assaData, 'world_lore.npc', {});\n  \n \n  // 合并NPC数据用于遍历，但保留路径判断逻辑\n  // 注意：这里我们需要知道NPC具体在哪个库里，以便生成正确的路径\n  var followedNpcs = [];      // 存储关注的NPC名字\n  var needsCondenseList = []; // 存储需要浓缩的路径\n\n  // 辅助函数：检查是否关注\n  function checkFollow(npcData) {\n    let follow = _.get(npcData, '_follow');\n    if (follow === undefined || follow === null) return false;\n    if (follow === true) return true;\n    if (typeof follow === 'string' && follow.toLowerCase() === 'true') return true;\n    return false;\n  }\n\n  // 遍历检查逻辑\n  // 1. 检查 Global NPC\n  for (const name in globalNpcs) {\n    const npc = globalNpcs[name];\n    if (checkFollow(npc)) {\n      followedNpcs.push(name);\n      // 检查进展长度\n      let progress = _.get(npc, '离线事件.进展');\n      if (progress && typeof progress === 'object' && Object.keys(progress).length > PROGRESS_LENGTH_THRESHOLD) {\n        needsCondenseList.push(`global_lore.npc.${name}.离线事件.进展`);\n      }\n    }\n  }\n\n  // 2. 检查 World NPC (如果名字重复，通常Global优先，但这里分别检查以防漏网)\n  for (const name in worldNpcs) {\n    // 如果已经在Global里处理过，跳过（避免重复）\n    if (globalNpcs[name]) continue;\n\n    const npc = worldNpcs[name];\n    if (checkFollow(npc)) {\n      followedNpcs.push(name);\n      // 检查进展长度\n      let progress = _.get(npc, '离线事件.进展');\n      if (progress && typeof progress === 'object' && Object.keys(progress).length > PROGRESS_LENGTH_THRESHOLD) {\n        needsCondenseList.push(`world_lore.npc.${name}.离线事件.进展`);\n      }\n    }\n  }\n\n  // 3小队信息\n  for (const name in groupNpcs) {\n    // 如果已经在Global里处理过，跳过（避免重复）\n    if (globalNpcs[name]) continue;\n    if (worldNpcs[name]) continue;\n\n    const npc = groupNpcs[name];\n    if (checkFollow(npc)) {\n      followedNpcs.push(name);\n      // 检查进展长度\n      let progress = _.get(npc, '离线事件.进展');\n      if (progress && typeof progress === 'object' && Object.keys(progress).length > PROGRESS_LENGTH_THRESHOLD) {\n        needsCondenseList.push(`global_lore.小队信息.${name}.离线事件.进展`);\n      }\n    }\n  }\n\n  // 格式化NPC列表字符串\n  const followedNpcsStr = followedNpcs.map(n => `[${n}]`).join('、');\n\n  // ===== 逻辑处理 =====\n  var npcsNeedingDetails = [];  // [修改] 仅存储需要补充细节的NPC（未达阈值）\n  var eventCondenseList = [];   // 需要浓缩事件的路径\n\n  // 辅助函数：获取当前已有的细节数量\n function getDetailCount(npcName) {\n  const gDetails = _.get(assaData, `global_lore.npc.${npcName}.角色细节`, {});\n  const gDetails2 = _.get(assaData, `global_lore.小队信息.${npcName}.角色细节`, {});\n  const wDetails = _.get(assaData, `world_lore.npc.${npcName}.角色细节`, {});\n  \n  return Math.max(\n    Object.keys(gDetails).length,\n    Object.keys(gDetails2).length,\n    Object.keys(wDetails).length\n  );\n}\n\n  // 1. 遍历所有来源的 NPC\n  // [修改] 合并 global_lore.npc, world_lore.npc 和 global_lore.小队信息\n  const allNpcs = Object.assign({}, worldNpcs, globalNpcs, groupNpcs);\n\n  for (const name in allNpcs) {\n    // 必须关注\n    if (checkFollow(allNpcs[name])) {\n      // [修改] 检查当前细节数量是否已达标\n      if (getDetailCount(name) < DETAIL_THRESHOLD) {\n        npcsNeedingDetails.push(name);\n      }\n    }\n  }\n\n \n\n  // [修改] 格式化需要补充细节的NPC列表字符串\n  const npcsNeedingDetailsStr = npcsNeedingDetails.map(n => `[${n}]`).join('、');\n\n  // ===== 只有当存在关注的NPC时才输出任何内容 =====\n  if (followedNpcs.length > 0) {\n//首先是角色细节\n_%>\n\n<%_\n  // [模块1] Game Notice 提示\n  if(double_api ===\"false\" || (double_api === \"true\" && batches === 1) ){\n_%>\ngame.notice(`\n以下角色可能会有离线平行事件：<%= followedNpcsStr %>，它会在后台自动推进。当你要将其离线事件汇入正文主线时，必须自然融入，不得突兀、时间线跳跃、地理位置跳跃。\n`)\n<%_\n  }\n_%>\n\n<%_\n  // [模块2] 离线事件推进任务\n  if(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\ngame.set('npc离线事件推进',`\n只对于以下重要npc：<%= followedNpcsStr %>，你需要在他们离线后（即不在正文出现，未和主线交汇）时，在其npc档案中初始化并维护一个额外字段:\"离线事件\":{}，作为离线时的特殊平行事件；而在登场后，视为离线事件和正文主线交汇，需设置离线事件状态为已中断；角色离线时，则需设置离线事件状态为进行中。同时，若角色换了在做的离线事件，则其简介需实时更新。\n更新步骤：你需要在loreAnalyze内部的末尾，按照固定格式逐个分析：\n离线事件check:\n以上npc(<%= followedNpcsStr %>)谁处于离线状态，谁处于登场状态？\n对于离线npc，对比下一次更新时间，该npc的离线事件是否需要初始化/更新？\n\n分析完成后，再继续进行相应步骤。若需要更新某觉得的离线事件，则必须：同步更新该npc的事件。若该角色的对应行动导致了npc档案中其他字段的变化，也需要百分百同步更新。\n<%_\n    if(is_parallels_event ===\"false\"){\n_%>\n更新规则：\n每轮根据当前的status.日期和status.时间，去和该事件的\"下次更新时间\"比对，去维护进行中的平行事件，若还没有抵达更新时间则直接忽略，无需更新。每个平行事件的数据结构是{\"简介\":\"string\",\"进展\":{\"${日期_时间}\":\"string//简述本轮该平行事件在如何发展。时间线不宜拖的太长，应结束时便应该干脆利落的结束\"},\"状态\":\"[未开始/进行中/已结束/已中断]\",\"下次更新时间\":\"string//距离上次最近一次进展，下一次需要更新进展是在什么时间？需要以${相对时间}(${绝对时间})的格式记录。如6个小时后(3月12日_12:00)\"}。\n\n以上所有字段可以完全不和正文有交集/有关联，也可以和主线自然交汇，但时间线和流速必须和正文一致，禁止时间跳跃。\n<%_\n    }else{\n_%>\n其格式和更新方式与${group}_lore.settings.世界信息.平行事件完全相同，即:\"离线事件\"{\"简介\":\"\",\"进展\":{},\"状态\":\"\",\"下次更新时间\":\"\"}。同样遵循认知屏障和时间线规则。\n<%_\n    }\n_%>\n`)\n<%_ if (npcsNeedingDetails.length > 0 && if_user_details===\"true\") { _%>\ngame.set('addition task:角色细节填充',`\n你还需要为以下重要npc<%= npcsNeedingDetailsStr %>在npc档案中初始化或填充\"角色细节”条目。你需要在本次更新中，立刻构思并新增**<%= DETAIL_NUM %>条**不和memory中的已有信息重复的增加真实感的细节信息，以${递增编号:num}:string的形式记录。若memory中未提到，则自己假定推理，你拥有直接定义的权限，直接假定信息是真的即可，无需使用可能、推测、大概等字眼。注意是新增！`)\n<%_ } _%>\n<%_\n    // [模块3] 浓缩任务 (仅在有需要浓缩的NPC且处于batch 2时输出)\n    if (needsCondenseList.length > 0) {\n      const condensePathsStr = needsCondenseList.map(p => `[${p}]`).join('、');\n_%>\ngame.set('addition task:浓缩角色离线事件进展', `\n以下角色的[离线事件.进展]字段条目过多，已超过系统阈值，需要进行历史数据聚合：<%= condensePathsStr %>。\n请在<updateMemory>中严格执行以下步骤：\n1. 使用delete指令清空该路径下的所有旧进展条目；\n2. 仅重新写入一条汇总数据，Key的格式为'${最早记录的时间}-${最后记录的时间}'，Value的内容为'行为链格式的事件总结，各节点间用->连接'。\n`)\n<%_\n    }\n_%>\n\n<%_\n  } // end of batch 2 check\n_%>\n\n<%_\n  } // end of followedNpcs.length check\n_%>\n","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":91,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":6,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"8":{"uid":8,"key":[],"keysecondary":[],"comment":"[可以关]关键记忆自动浓缩(80条总结)","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n //变量任务\nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n<%_\n\n  // ===== 配置区 =====\n  const MEMORY_LENGTH_THRESHOLD = 80;  // 关键记忆总结的长度阈值，玩家，也就是你可以自行修改\n  \n  function getDataWithFallback_chat(varName) {\n    let data = getLocalVar(varName);\n    \n    const isValid = (data) => {\n      if (data === null || data === undefined) {\n        return false;\n      }\n      if (typeof data === 'object' && data !== null) {\n        if (Array.isArray(data)) {\n          return data.length > 0;\n        }\n        return Object.keys(data).length > 0;\n      }\n      return true;\n    };\n    \n    if (!isValid(data)) {\n      data = getLocalVar(varName);\n    }\n    return data;\n  }\n\n\n  // ===== 数据获取 =====\n  if (typeof assaData === 'undefined') {\n    var assaData = getDataWithFallback_chat(\"assa_data\");\n  }\n\n  var globalNpcs = _.get(assaData, 'global_lore.npc', {});\n var groupNpcs = _.get(assaData, 'global_lore.小队信息', {});\n  var worldNpcs = _.get(assaData, 'world_lore.npc', {});\n  \n  // 合并所有NPC数据，优先级：全局NPC > 世界NPC\n  var allNpcsData = Object.assign({}, worldNpcs, globalNpcs,groupNpcs);\n  \n  // ===== 检查逻辑 =====\n var needsCondenseList = [];  // 存储需要浓缩的NPC路径\n\nfor (const npcName in allNpcsData) {\n  const npcData = allNpcsData[npcName];\n\n  if (npcData && typeof npcData === 'object') {\n    // 尝试从不同路径获取关键记忆\n    let keyMemory;\n    let npcPath;\n\n    // 检查 global_lore.npc\n    keyMemory = _.get(assaData, `global_lore.npc.${npcName}.关键记忆`);\n    npcPath = `global_lore.npc.${npcName}`;\n\n    // 如果没找到，检查 global_lore.小队信息\n    if (!keyMemory) {\n      keyMemory = _.get(assaData, `global_lore.小队信息.${npcName}.关键记忆`);\n      npcPath = `global_lore.小队信息.${npcName}`;\n    }\n\n    // 如果还没找到，检查 world_lore.npc\n    if (!keyMemory) {\n      keyMemory = _.get(assaData, `world_lore.npc.${npcName}.关键记忆`);\n      npcPath = `world_lore.npc.${npcName}`;\n    }\n\n    // --- 核心修正逻辑 ---\n    // 检查关键记忆是否存在，并且是一个非数组的对象\n    if (keyMemory && typeof keyMemory === 'object' && !Array.isArray(keyMemory)) {\n      const memoryCount = Object.keys(keyMemory).length; // 获取对象中键的数量\n\n      // 检查记忆条数是否超过阈值\n      if (memoryCount > MEMORY_LENGTH_THRESHOLD) {\n        needsCondenseList.push(npcPath);\n        }\n      }\n    }\n  }\n  \n  // ===== 生成输出 =====\n  var finalOutput = '';\n  \n  if (needsCondenseList.length > 0) {\n    const pathsFormatted = needsCondenseList\n      .map(path => `[${path}]`)\n      .join('、');\n    \n    finalOutput = `以下角色的关键记忆字段过长，需要被浓缩精简：${pathsFormatted}。请在<updateMemory>中，先使用delete指令删除以上角色的关键记忆字段，再依次重新memory。要求是浓缩冗余、不够重要、内容重复的关键记忆，对于特别重要的关键记忆和言行则原样记录。`;\n  }\n%>\n<% if (finalOutput) { %>\ngame.set('addition task:浓缩角色关键记忆', `\n<%= finalOutput %>\n`)\n<% } %>\n<% } %>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":92,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":7},"9":{"uid":9,"key":[],"keysecondary":[],"comment":"[可以关]npc角色关系表","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\ngame.set('角色关系追踪',`\n你还需要在${group}_lore.settings中维护`角色关系`字段，记录更新npc之间的角色关系，必须精准、全面。涉及<user>的关系无需记录，因为已在各npc档案中分布式记录了。其标准格式为：\n\"角色关系\":{\n${递增编号}:{\"from\": \"A\", \"to\": \"B\", \"type\": \"朋友(在此处做简略介绍。若有单方面关系，则也精准记录。如:A是B的XX，B是A的XX)\"},...}\n`)\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":92,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":8,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"10":{"uid":10,"key":[],"keysecondary":[],"comment":"[可以关]不重要的npc用简单模式","content":"<%_\nvar simple_npc_format=`\nsimple_format:npcname:{\n\"外貌\":\"string\",\n\"身份\":\"string\",\n\"info\":\"string\"//简单的简介\n}//对不重要的npc则只需用simple_format初始化，对重要npc则必须完整初始化`;\n  setLocalVar('simple_npc_format', simple_npc_format);\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":0,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":10,"characterFilter":{"isExclude":false,"names":[],"tags":[]}}}}