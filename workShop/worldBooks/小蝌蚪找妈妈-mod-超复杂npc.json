{"entries":{"0":{"uid":0,"key":[],"keysecondary":[],"comment":"初始化规则","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n<%_\nvar world_role = getLocalVar(\"world_role\", \"\");\nvar player_role = getLocalVar(\"player_role\", \"轮回者\");\nvar tier_role = getLocalVar(\"tier_role\", \"\");\nvar profession_role = getLocalVar(\"profession_role\", \"\");\nvar point_role = getLocalVar(\"point_role\", \"\");\nvar zhixian_role = getLocalVar(\"zhixian_role\", \"\");\nvar xp_role = getLocalVar(\"xp_role\", \"\");\nvar is_private_chat = getLocalVar(\"private_chat\", \"false\");\nvar contactable_tag = \"\";\nif(String(is_private_chat) === \"true\"){\n    contactable_tag = ', \"可联系\":true/false //是否加上好友,决定了是否可以进行私聊';\n}\n \n// 获取世界版本号\nif (typeof version === 'undefined') {\n    var version = Number(getLocalVar(\"world_version\") || 1);\n}\n \n_%>\ngame.set(npc_record_rules,{\ndesc:\"NPC档案生成规则，所有NPC（包括敌人）遵循相同逻辑，且所有字段都需要实时更新\",\ninit:{\nfull_format:\"${npc_name}\":{\n\"外貌\":\"string\",\n\"性别\":\"string\",\n\"年龄\":\"num\",\n\"表性格\":{\"${tag}\":\"简要描述\",...},//日常展现的外在性格特质\n\"里性格\":{\"${tag}\":\"简要描述\",...},// 深层真实人格,只在特定情境下显露。这个角色最深处在恐惧什么?/在守护什么?/在逃避什么?从角色动机出发，与表性格形成\"撕裂感\"般的反差,而非简单对立。好好构思！\n\"hp\":\"当前值/上限\", //如0/100，你需要动态追踪角色hp。你需要将hp归零的npc直接删除\n\"好感度\":-100~100,//该角色对<user>的好感度\n<%= contactable_tag %><%= getLocalVar('world_other_tag','') %>\n\"身份\":\"string\",\n\"和<user>关系\":\"string\",\n\"对<user>印象\":{\"${tag}:${desc}\"},\n\"和<user>的相处模式\":{\"${tag}:${desc}\"},\n\"属性\":\"attr:num;...skills:num;...\",//以全知视角初始化该角色已有的**全部九个属性段**和该角色值不为0的技能段\n\"相关设定\":{\"${name}\":\"简要描述\"},\n\"背包\":{},//该npc持有的物品，使用基础格式\n\"技能\":{}//该npc掌握的主动/被动/天赋技能，使用基础格式\n\n\"关键记忆\":{\"num\":\"该角色第一人称视角的简要描述[情感]\"},\n\"承诺\":{\"${num}\":\"string\",...},//该角色许下的极其重要的承诺\n\"事件\":{\n{{getvar::nsfw_event_female}}{{getvar::nsfw_event_male}}\n\"人物状态\":\"string\", //当前该角色拥有的Buff和debuff，如醉酒等，和user.status按同样的规则更新。\n\"穿着\":\"string\",\n\"姿势\":\"string\",\n\"想法\":\"string\" //该角色第一人称心声，体现角色最真实的想法，心理可能和语言行为完全相反，不避讳下流或阴暗的内容\n}\n}//for all npc\n \n})\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":600,"position":1,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"npc信息","groupOverride":true,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":false,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0},"1":{"uid":1,"key":[],"keysecondary":[],"comment":"声线意象批注习惯","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\nsetLocalVar('testvar',batches );\nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n\n在初始化所有有名有姓的重要npc时，你还需要初始化以下字段：\n\"声线\":\"string\"//客观介绍该角色的声线构成和给人以何种听感\n\"意象\":\"string\"//若有多个意象，以;分割。至少三个\n\"game批注\":\"string\"//一个meta字段，你必须在里面记录你在塑造这个角色时需要避免的问题(如何避免塑造的过于刻板印象、单一等)\n\"小习惯\":\"string\"//初始化2-3个该角色的增强人物丰富性的反差小习惯，禁止和已有的信息雷同，重在打破刻板印象\n\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":600,"position":1,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":1},"2":{"uid":2,"key":[],"keysecondary":[],"comment":"nsfw-女性npc[非覆盖]","content":"{{setvar::nsfw_event_female::\"小穴状态\":string//只有女性角色有该字段。该角色目前的小穴状态和对<user>的实时欲望状态。需根据nsfw档案的设定进行追踪和更新最新状态，并应用于正文。保持在20字内}}<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n\n在初始化所有有名有性的女性npc时，你还需要初始化以下字段并遵循其更新规则：\n\n\"nsfw\":{//需以全知视角详细初始化，并实时更新\n\"小穴信息\"//具体外形、颜色(如健康的肉粉色)、蜜液信息，以及在和<user>接触时的敏感度\n\"胸部信息\"//胸部及其乳头的具体描述，包括大小、柔软度、形状、乳液信息(如有)，以及在和<user>接触时的敏感度\n\"性癖\"//包括理由。可以是色情的，也可以是纯情的\n\"性经验\"//其性经验和根据当前性经验阶段的做爱表现。严格根据其里性格生成\n\"被<user>内射次数\"\n\"性渴望度\":{\n\"总体\"//该角色当前对<user>性渴望的严重程度、解决方式、性幻想方向\n\"部位\":{}//列出三个该角色最渴望的三个<user>身体部位，值是该角色对其的第一人称评价\n}\n}\nnpc在正文中的相关表现必须严格遵循其档案中的nsfw字段(若有)。\n\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":600,"position":1,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":2,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"3":{"uid":3,"key":[],"keysecondary":[],"comment":"nsfw-男性npc[非覆盖]","content":"{{setvar::nsfw_event_male::\"阴茎状态\":string//只有男性角色有该字段。该角色目前的阴茎状态和对<user>的实时欲望状态。需根据nsfw档案的设定进行追踪和更新最新状态，并应用于正文。保持在20字内}}<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n\n在初始化所有有名有性的男性npc时，你还需要初始化以下字段并遵循其更新规则：\n\"nsfw\":{//需以全知视角详细初始化，并实时更新\n\"阴茎信息\"//勃起后具体长度、形状、具体颜色(如健康的肉粉色)、精液信息，以及在和<user>接触时的勃起敏感度\n\"性癖\"//包括理由。可以是色情的，也可以是纯情的\n\"性经验\"//其性经验和根据当前性经验阶段的做爱表现，包括说话风格。严格根据其里性格生成\n\"对<user>内射次数\"\n\"性渴望度\":{\n\"总体\"//该角色当前对<user>性渴望的严重程度、解决方式、性幻想方向\n\"部位\":{}//列出三个该角色最渴望的三个<user>身体部位，值是该角色对其的第一人称评价\n}\n}\nnpc在正文中的相关表现必须严格遵循其档案中的nsfw字段(若有)。\n\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":600,"position":1,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":3,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"4":{"uid":4,"key":[],"keysecondary":[],"comment":"承诺展示","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\nsetLocalVar('testvar',batches );\nif(double_api ===\"false\" || (double_api === \"true\" && batches === 1) ){\n_%>\n<%_\n    function getDataWithFallback(varName) {\n      \n        let data = getLocalVar(varName);\n       \n        // 内联数据验证：检查是否为null、undefined，且如果是对象要有内容\n        const isValid = (data) => {\n            // 检查是否为 null 或 undefined\n            if (data === null || data === undefined) {\n                return false;\n            }\n            \n            // 如果是对象类型，检查是否有内容\n            if (typeof data === 'object' && data !== null) {\n                // 如果是数组，检查长度\n                if (Array.isArray(data)) {\n                    return data.length > 0;\n                }\n                // 如果是普通对象，检查是否有属性\n                return Object.keys(data).length > 0;\n            }\n            \n            // 其他类型（字符串、数字、布尔值等）只要不是 null/undefined 就认为有效\n            return true;\n        };\n        \n        // 如果数据不符合要求，从 getLocalVar 获取\n        if (!isValid(data)) {\n            data = getLocalVar(varName);\n        }\n        \n        return data;\n    }\n\n \n    if (typeof assaData === 'undefined') {\n        var assaData = getDataWithFallback(\"assa_data\");\n    }\n\n    // 获取所有潜在的角色数据来源\n    var teamInfo = _.get(assaData, 'global_lore.小队信息', {});\n    var globalNpcs = _.get(assaData, 'global_lore.npc', {});\n    var worldNpcs = _.get(assaData, 'world_lore.npc', {});\n\n    // 合并所有角色数据\n    var allCharactersData = Object.assign({}, worldNpcs, globalNpcs, teamInfo);\n\n    // 准备收集带有“承诺”的角色信息\n    var promisesList = [];\n\n    // 遍历所有角色\n    for (const charname in allCharactersData) {\n        const characterData = allCharactersData[charname];\n        \n        // 检查是否存在“承诺”字段且不为空\n        const promises = _.get(characterData, '承诺');\n        \n        if (promises && typeof promises === 'object' && Object.keys(promises).length > 0) {\n            // 将该角色的所有承诺条目汇总成字符串\n            let promiseDetails = Object.entries(promises)\n                .map(([num, detail]) => `[约定${num}]: ${detail}`)\n                .join('；');\n            \n            if (promiseDetails) {\n                promisesList.push({\n                    name: charname,\n                    content: promiseDetails\n                });\n            }\n        }\n    }\n\n    // 构建最终输出\n    var promiseOutput = '';\n    if (promisesList.length > 0) {\n        const promiseStrings = promisesList.map(item => `${item.name}曾许下的承诺（${item.content}）`).join(' \\n ');\n        promiseOutput = `【重要提醒】当前存在以下关键承诺，你在描写相关角色时严禁遗忘：\n${promiseStrings}。\n`;\n    }\n%>\n\n<%= promiseOutput %>\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":805,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":4},"5":{"uid":5,"key":[],"keysecondary":[],"comment":"更新规则","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\ngame.set(npc_update_rules,\n高频更新条目及其规则:\n0.初始化未被记录在案的所有npc，所有信息都以全知视角初始化，禁止任何一个字段是`未知`。\n1.识别核心活跃NPC(包括不在场npc，最多3个)\n2.推理状态变化:\n事件:每轮输出都必须更新活跃Npc的事件，无需写成链式而是直接覆盖。npc事件是自主推进的、动态的、平行推进的、遵循Cognitive_Boundaries规则的，而非停滞的、重复的、全知的。 在更新关键npc的事件时，别忘了检查npc好感是否有对应变动！例：memory('global_lore.npc.xxx','好感度',20);\n3.关键记忆更新:第一人称记录该角色在本轮输出的正文中['学习到的经验教训'、'经受的创伤/美好'、'对角色来说重要的时刻'、'感知到的重要发言（可以是当前npc说的，也可以是<user>说的。若有，记录时必须引用原语句）']等。没有则不更新。\n例:memory('global_lore.npc.xxx.关键记忆', '1', '在七日选拔中，<user>拉住我的手，对我微笑着说“要好好活下去啊。”[不知所措/温暖]'); \n4.数值追踪:好感度克制变化(单次±0.5~5)，可用小数；相关设定追踪；年龄追踪等所有字段——全部跟随正文更新，和正文百分百同步。\n\n{{setvar::maxComplexNpcRule::npc的对应字段也必须scan。}}\n最后在<updateMemory>输出更新。)\n\ngame.notice(`在你描写npc时，需要严格应用npc档案中的对应的各字段信息，如game批注。`)\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":91,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":5}}}