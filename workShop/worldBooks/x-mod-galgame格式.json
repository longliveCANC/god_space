{"entries":{"0":{"uid":0,"key":[],"keysecondary":[],"comment":"gal","content":"<%_\n//把显示数自动设置成1\nsetLocalVar(\"assa_data.config.show_latest_count\",1);\nvar double_api = getLocalVar(\"double_api\") || \"false\";\nvar batches = getLocalVar(\"batches\") || 1;\n\n// 1. 读取并解析差分数据\nvar expressionJsonStr = getLocalVar(\"available_expressions_json\") || \"{}\";\nvar expressionMap = {};\ntry {\n    expressionMap = JSON.parse(expressionJsonStr);\n} catch (e) {\n    expressionMap = {};\n}\n\n// 2. 判断是否有差分数据\nvar hasExpressions = Object.keys(expressionMap).length > 0;\nvar expressionListStr = \"\";\n\nif (hasExpressions) {\n    // 构建展示字符串： 名字:[差分1,差分2]\n    expressionListStr = Object.entries(expressionMap)\n        .map(([name, exps]) => name + \":[\" + exps.join(\",\") + \"]\")\n        .join(\"\\n\");\n}\n\nif ((double_api === \"true\" && batches === 1) || double_api === \"false\") {\n_%>\n game.set('正文格式', `\n正文请完全按照【Galgame模式】进行输出。\n1. 角色说话：请用“${角色名}|${内容}”的格式。例：xxx|xxx。若该角色有npc档案，则此处的名字必须和该npc档案的名字**完全**一致，以展示默认立绘。\n2. 旁白/心理活动：直接写内容。\n<%_ if (hasExpressions) { _%>\n3. 差分规则：以下角色拥有差分立绘，可以使用“${角色名}|${差分名}|${内容}”的格式来展现角色的情绪。\n可差分NPC及列表：\n<%- expressionListStr %>\n<%_ } _%>\n`)\n<%_\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":9777,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"1":{"uid":1,"key":[],"keysecondary":[],"comment":"cg开-手动放入cg信息-二选一","content":"<%_\nvar double_api = getLocalVar(\"double_api\") || \"false\";\nvar batches = getLocalVar(\"batches\") || 1;\n \nif ((double_api === \"true\" && batches === 1) || double_api === \"false\") {\n_%>\n game.set('cg list', `\n在需要展示cg的时候，可以这样输出：cg|${cg名}。以下是可用的cg列表：\n[你在这里自己填]\n`)\n<%_\n \n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":9778,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"2":{"uid":2,"key":[],"keysecondary":[],"comment":"cg开-自动遍历cg信息-二选一","content":"<%_\nvar double_api = getLocalVar(\"double_api\") || \"false\";\nvar batches = getLocalVar(\"batches\") || 1;\n\n// 1. 读取并解析 CG 数据\n// 注意：这里读取的是 available_cgs_json，默认值是空数组字符串 \"[]\"\nvar cgJsonStr = getLocalVar(\"available_cgs_json\") || \"[]\";\nvar cgList = [];\ntry {\n    cgList = JSON.parse(cgJsonStr);\n} catch (e) {\n    cgList = [];\n}\n\n// 2. 判断是否有 CG 数据并构建字符串\nvar hasCgs = cgList.length > 0;\nvar cgDisplayStr = \"\";\n\nif (hasCgs) {\n    // 将数组连接成字符串，例如: \"日落, 战斗, 教室\"\n    cgDisplayStr = cgList.join(\", \");\n} else {\n    cgDisplayStr = \"暂无可用CG\";\n}\nif (hasCgs) {\n\nif ((double_api === \"true\" && batches === 1) || double_api === \"false\") {\n_%>\n game.set('cg', `\n在需要展示对应cg的时候，以此格式输出：cg|${cg名称}。\n可用的cg列表：\n[<%- cgDisplayStr %>]\n`)\n<%_\n}\n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":9778,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"3":{"uid":3,"key":[],"keysecondary":[],"comment":"TTS分配","content":" <%_  \nvar double_api= String(getLocalVar(\"double_api\")|| \"false\");\nvar batches = Number(getLocalVar(\"batches\")|| 1);\n//更新规则\nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\n<%_\n// =================================================================================\n// EJS - 自动分配TTS模型\n// 功能：找出所有未配置TTS模型的NPC，并请求AI使用现有模型进行分配。\n// =================================================================================\n\n// 辅助函数：安全地从多个可能的位置获取数据\nfunction getDataWithFallback(varName) {\n    let data = getLocalVar(varName);\n    const isValid = (d) => d !== null && d !== undefined && (typeof d !== 'object' || Object.keys(d).length > 0 || Array.isArray(d) && d.length > 0);\n    if (!isValid(data)) {\n        data = getLocalVar(varName);\n    }\n    return data;\n}\n\n// 1. 获取核心数据\nvar assaData = getDataWithFallback(\"assa_data\") || {};\nvar availableModels = JSON.parse(getLocalVar('available_models') || '[]');\nvar voiceMap = _.get(assaData, 'voice_map', {});\n\n// 2. 收集所有NPC的名称\nvar allNpcNames = new Set();\nvar addKeysToSet = (obj) => {\n    if (obj && typeof obj === 'object') {\n        Object.keys(obj).forEach(key => allNpcNames.add(key));\n    }\n};\n\n// 从世界、全局和队伍信息中收集NPC\naddKeysToSet(_.get(assaData, 'world_lore.npc'));\naddKeysToSet(_.get(assaData, 'global_lore.npc'));\naddKeysToSet(_.get(assaData, 'global_lore.小队信息'));\n// 从立绘映射中也收集一次，确保有立绘的角色也被考虑\naddKeysToSet(_.get(assaData, 'img_map'));\n\n// 3. 筛选出没有配置TTS模型的NPC\nconst npcsWithoutVoice = [];\nallNpcNames.forEach(npcName => {\n    // 检查 voiceMap 中是否存在该NPC的有效映射（非空字符串）\n    if (!voiceMap[npcName]) {\n        npcsWithoutVoice.push(npcName);\n    }\n});\n\n// 4. 如果存在需要配置的NPC，并且我们有可用的模型列表，则生成AI指令\nif (npcsWithoutVoice.length > 0 && availableModels.length > 0) {\n    const npcListString = JSON.stringify(npcsWithoutVoice);\n    const modelListString = JSON.stringify(availableModels);\n_%>\ngame.set('addition task:TTS模型分配', {\n    你还需要为角色分配语音模型。请分析以下角色列表，并根据他们性别、性格、音色等特征，从给定的模型列表中为他们选择最合适的语音。\n    - **需要分配的角色:** <%= npcListString %>\n    - **可用的语音模型:** <%= modelListString %>\n输出格式为：memory('voice_map.${npc_name}','${语音模型名称}')\n});\n<%_\n}}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":92,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"4":{"uid":4,"key":[],"keysecondary":[],"comment":"插入代码前端CG-可选","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 1) ){\n_%>\ngame.set('插入前端',`\n在剧情中的适当时机，使用一个或多个前端美化来替代部分纯文本描述。\n美化要求：\n1、单个美化设计前后必须使用<html></html>包裹，以方便被游戏主界面识别并渲染为iframe。\n2、 必须实现的技术要点：使用多层boxshadow制造浮空感、用伪元素::before/::after添加装饰层等，使其保持美观。\n\n必须美化的时机：玩家和某样物品有视觉交互(如获取某物品/查看某物品)/有系统信息出现/系统通知等。\n`)\n<%_  \n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":232,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0}}}