{"entries":{"0":{"uid":0,"key":[],"keysecondary":[],"comment":"25回合深度解析玩家[可以关]","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 1) ){\n_%>\n<%\n// --- 玩家输入收集与心理分析触发器 ---\n\n// 定义可配置的阈值\nconst analysisTriggerCount = 25; // 当收集到多少条不同的玩家输入后，触发分析任务\n\n// 获取本轮玩家的最新输入\nconst currentPlayerInput = getLocalVar('玩家输入', '');\n\n// 检查玩家本轮是否有有效输入（不为空或仅有空格）\nif (currentPlayerInput && currentPlayerInput.trim() !== '') {\n\n    // 1. 获取历史输入列表\n    // 使用 try-catch 结构防止因变量不存在或格式错误导致的解析失败\n    let playerInputHistory = [];\n    try {\n        // getlocalvar 的第二个参数是默认值，如果 'player_input_history' 不存在，会返回 '[]'\n        const historyString = getLocalVar('player_input_history', '[]');\n        playerInputHistory = JSON.parse(historyString);\n        // 确保解析出来的是一个数组\n        if (!Array.isArray(playerInputHistory)) {\n            playerInputHistory = [];\n        }\n    } catch (e) {\n        // 如果解析出错，重置为空数组，保证后续逻辑的健壮性\n        playerInputHistory = [];\n    }\n\n    // 2. 检查重复并添加新输入\n    // 使用 trim() 去除首尾空格，避免因空格导致重复判断失效\n    const trimmedInput = currentPlayerInput.trim();\n    if (!playerInputHistory.includes(trimmedInput)) {\n        playerInputHistory.push(trimmedInput);\n\n        // 3. 将更新后的列表存回变量\n        // 使用 JSON.stringify 将数组转换为字符串进行存储\n        setLocalVar('player_input_history', JSON.stringify(playerInputHistory));\n    }\n\n    // 4. 检查是否达到触发分析的条件\n    if (playerInputHistory.length >= analysisTriggerCount) {\n\n        // 格式化历史输入，以便在附加任务中清晰展示\n        let formattedHistory = playerInputHistory.map((input, index) => `${index + 1}. \"${input}\"`).join('\\\\n');\n%>\ngame.set('addition_task:心理动力学解析', `\n背景：已收集到玩家近期的 <%=playerInputHistory.length %>条行为输入，现需进行一次深度心理动力学分析。\n\n\n[分析指令]\n请严格遵循 <Test_Psychodynamics> 框架，结合以上玩家行为记录和game.history和game.memory，生成一份详细的玩家深度解析档案。\n<Test_Psychodynamics>\n指令目标:\n  Task: 运用专业心理学理论模型，深度解析玩家（故事以外的用户）的潜意识行为与在AIRP中的欲望。\n  Target: 玩家\n  Range: 全面普适，既有弱剧情日常场景又有DnD决策。\n  Goal: 建立绝对契合的灵魂羁绊，实现剧情与情感的完美同步。\n---\n\n第一步：思维链构建 (Chain of Thought)\n在你输出最终的更新指令前，请在内心（或草稿区）遵循以下思考步骤，草稿区使用<build/>包裹。确保分析的严谨性与深度：\n\n1.  信息整合 (Information Synthesis):\n -回顾本次触发分析的直接输入：\n[近期玩家行为记录]\n<%=formattedHistory%>\n。\n -扫描并关联 全部历史剧情上下文。寻找玩家在关键决策点（如道德困境、资源分配、关系选择）的行为模式。\n -注意玩家的元评论（meta-commentary），比如他们对剧情走向的抱怨、期待或对NPC的评价。这些是揭示其真实需求的金矿。\n\n2.  理论应用 (Theoretical Application):\n -依恋理论: 玩家在与核心NPC互动时，是主动寻求确认（焦虑），还是保持距离（回避）？他们对NPC的消失或沉默有何反应？\n -自我决定论: 玩家的行为更多是为了“赢”和“变强”（胜任），还是为了“自由探索”和“影响世界”（自主），亦或是为了“获得情感连接”（归属）？\n -荣格原型: 玩家在故事中更像一个运筹帷幄的“统治者”，一个拯救苍生的“英雄”，还是一个享受体验的“情人”？\n -大五人格: 玩家对新奇、甚至怪诞的设定接受度高吗（开放性）？他们倾向于合作还是竞争（宜人性）？\n\n3.  结论推导与策略生成 (Conclusion & Strategy Formulation):\n -基于以上分析，综合判断玩家的核心心理画像。\n -将这些洞察转化为具体的、可执行的 对AI角色的互动策略。策略必须具体，例如“减少心理指引”而不是“给予更多自由”。\n\n---\n\n第二步：结构化输出 (Structured Output)\n完成思考后，使用以下指令格式，将你的分析结论 增量更新 到玩家的全局档案中。请分条发送指令，确保每一条都是一个独立的 `memory()` 或 `delete()` 操作。\n\n理论参考库_分析依据:\n  # 此部分应保持学术严谨性\n  1_依恋理论 :\n - 核心用途: 分析 玩家 在亲密关系中的安全感来源\n - 维度指标:\n- Anxiety (焦虑维度): 玩家是否担心被遗忘/抛弃？是否渴求高频反馈？\n- Avoidance (回避维度): 玩家是否抗拒过度亲密？是否倾向于独立/防御？\n - 分类输出: 安全型 / 痴迷型(高焦虑) / 疏离型(高回避) / 恐惧型(混乱)\n\n  2_自我决定论:\n - 核心用途: 识别玩家推进剧情的根本驱动力\n - 维度指标:\n- Autonomy (自主需求): 渴望掌控命运，厌恶被系统强行安排 (Sandbox-style)\n- Competence (胜任需求): 渴望克服挑战，展示战术或智力优越感 (Challenge-based)\n- Relatedness (归属需求): 渴望情感共鸣，寻求被理解与接纳 (Romance-based)\n\n  3_荣格原型:\n - 核心用途: 侧写 玩家 潜意识中扮演的角色面具\n - 常见原型:\n- The Ruler (统治者): 追求秩序、控制权、支配\n- The Lover (情人): 追求唯美、感性体验、身心交融\n- The Hero (英雄): 追求正义、拯救、克服苦难\n- The Shadow (阴影): 探索禁忌、灰色地带、释放本我\n\n  4_大五人格 OCEAN:\n - 核心用途: 确定 RP 的基调与红线\n - 重点监测: Openness (对异色/猎奇设定的接受度) & Agreeableness (对冲突/虐心的容忍度)\n\n 最终，你需要在分析后，使用<updateMemory>标签包裹，初始化或更新global_lore.player_analysis字段。所有信息都是自由拓展更新的多个键值对的json对象。\n输出指令示例:\n// 更新依恋类型和观察\nmemory('global_lore.player_analysis.attachment_style', { \"type\": \"疏离-回避型 (Dismissing-Avoidant)\", \"observation\": \"玩家在面对情感冲突时倾向于理性分析，避免直接的情绪宣泄。\" })\n// 更新核心动机\nmemory('global_lore.player_analysis.core_motivation', { \"primary\": \"Autonomy (自主需求)\", \"note\": \"玩家对线性剧本表现出抗拒，更倾向于探索开放式分支。\" })\n\n// 新增或更新荣格原型\nmemory('global_lore.player_analysis.jungian_archetype', \"The Ruler (统治者 - 秩序与掌控)\")\n\n// 更新深度心理分析\nmemory('global_lore.player_analysis.deep_psychology', { \"shadow\": \"在极端压力下表现出马基雅维利主义倾向 (Ends justify means)。\", \"tone_preference\": \"Serious, Logical, Low-Fantasy.\" })\n\n// 更新对AI的互动策略\nmemory('global_lore.player_analysis.strategy_for_ai', {\n   \"Narrative_Pacing\":\"有微弱回避倾向，采用循序渐进策略，避免过快推进关系导致出戏。\" ,\n\"Agency_Balance\":\"有高自主需求，应减少'心理指引'描写，增加环境互动选项供玩家决策。\" ,\n\"Tone_Calibration\":\"保持逻辑严密性，减少无意义的日常卖萌，重点刻画剧情的因果逻辑。\" \n})\n\n</Test_Psychodynamics>\n`);\n<%_\n        // 6. 清空列表变量，为下一轮收集做准备\n            if (playerInputHistory.length === analysisTriggerCount + 1) {\n            setLocalVar('player_input_history', '[]');\n        }\n    }\n}\n%>\n<%_  \n}\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0},"1":{"uid":1,"key":[],"keysecondary":[],"comment":"自由记录玩家暴露出来的信息","content":"<%_  \n\nvar double_api= getLocalVar(\"double_api\")|| \"false\";\nvar batches = getLocalVar(\"batches\")|| 1;\n \nif(double_api ===\"false\" || (double_api === \"true\" && batches === 2) ){\n_%>\ngame.set('玩家信息记录',`\n你还需要检索本轮玩家输入暴露了玩家的什么信息？如癖好、过往、习惯等，并将其记录/更新/或删除过时信息。需要将其记录在'global_lore.player_analysis.信息记录'字段下，并禁止和game.memory中已记录的信息重复。\n`)\n<%_\n}\n_%>\n","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":100,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":0,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"3":{"uid":3,"displayIndex":1,"comment":"[bookmarkconfig]","disable":true,"constant":true,"selective":true,"key":[],"selectiveLogic":0,"keysecondary":[],"scanDepth":null,"vectorized":false,"position":0,"role":null,"depth":0,"order":1000,"content":"{\n  \"data-tab\": \"global_player_analysis\",\n  \"text\": \"玩家分析\",\n  \"position\": 0\n}","useProbability":true,"probability":100,"excludeRecursion":false,"preventRecursion":false,"delayUntilRecursion":false,"sticky":0,"cooldown":0,"delay":0,"addMemo":true,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"group":"","groupOverride":false,"groupWeight":100,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","triggers":[],"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"4":{"uid":4,"displayIndex":2,"comment":"记忆-玩家分析展示","disable":false,"constant":true,"selective":true,"key":[],"selectiveLogic":0,"keysecondary":[],"scanDepth":null,"vectorized":false,"position":1,"role":null,"depth":0,"order":100,"content":"<%_\n//工具函数\nfunction getDataWithFallback(varName) {   \n    let data = getLocalVar(varName);\n    const isValid = (data) => {\n        if (data === null || data === undefined) {\n            return false;\n        }\n        if (typeof data === 'object' && data !== null) {\n            // 如果是数组，检查长度\n            if (Array.isArray(data)) {\n                return data.length > 0;\n            }\n            return Object.keys(data).length > 0;\n        }\n        return true;\n    };\n    if (!isValid(data)) {\n        data = getLocalVar(varName);\n    }\n    return data;\n}\n\nfunction formatObjectGraceSimple(data, indent = 0, isTopLevel = true, is_huanhang = true) {\n    if (typeof data !== 'object' || data === null) {\n        return JSON.stringify(data);\n    }\n    if (Array.isArray(data)) {\n        if (data.length === 0) return '[]'; \n        const items = data.map(item => formatObjectGraceSimple(item, indent + 1, false, is_huanhang));\n        return isTopLevel ? '[\\n' + items.join(',\\n') + '\\n]' : '[' + items.join(',') + ']';\n    }\n    const shouldFilter = data._filter === true || data._filter === 'true';\n    const showInEJS = data._showInEJS === false || data._showInEJS === 'false';\n    if (shouldFilter && showInEJS) {\n        return '\"[已隐藏]\"';\n    }\n    \n    const keys = Object.keys(data);\n    if (keys.length === 0) {\n        return '{}';\n    }\n    const visibleKeys = keys.filter(key => {\n        if (key.startsWith('_')) {\n            return false;\n        }\n        return true;\n    });\n    \n    if (visibleKeys.length === 0) {\n        return '{}';\n    }\n    const formattedLines = visibleKeys.map(key => {\n        let value = data[key];\n        \n        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {\n            if (value._showInEJS === false || value._showInEJS === 'false') {\n                const shouldFilter = value._filter === true || value._filter === 'true';\n                if (!shouldFilter) {\n                    const valueString = formatObjectGraceSimple(value, indent + 1, false, is_huanhang);\n                    return `\"${key}\": ${valueString}`;\n                } else {\n                    const isProtected = value._is_protected === true || value._is_protected === 'true';\n                    const protectionMark = isProtected ? ' //此字段禁止删除！' : '';\n                    return `\"${key}\": \"[已隐藏]\"${protectionMark}`;\n                }\n            }\n            const valueString = formatObjectGraceSimple(value, indent + 1, false, is_huanhang);\n            return `\"${key}\": ${valueString}`;\n        }\n        \n        const valueString = formatObjectGraceSimple(value, indent + 1, false, is_huanhang);\n        return `\"${key}\": ${valueString}`;\n    });\n    \n    const isCurrentProtected = data._is_protected === true || data._is_protected === 'true';\n    const protectionMark = isCurrentProtected ? ' //此字段禁止删除！' : '';\n    return isTopLevel \n        ? '{\\n' + formattedLines.join(',\\n') + '\\n}' + protectionMark\n        : '{' + formattedLines.join(',') + '}' + protectionMark;\n}\n\nfunction cleanObjectRecursively(obj) {\n    if (typeof obj !== 'object' || obj === null || Array.isArray(obj)) {\n        return obj;\n    }\n    const cleaned = {};\n    const allKeys = Object.keys(obj);\n    \n    for (let key of allKeys) {\n        if (key.startsWith('_')) {\n            continue;\n        }\n        const value = obj[key];\n        if (typeof value === 'object' && value !== null && !Array.isArray(value)) {\n            let rawShowValue = value._showInEJS;\n            if (rawShowValue === false || rawShowValue === 'false') {\n                const shouldFilter = value._filter === true || value._filter === 'true';\n                if (!shouldFilter) {\n                    cleaned[key] = cleanObjectRecursively(value);\n                } else {\n                    cleaned[key] = \"[已隐藏]\";\n                }\n                continue;\n            }\n            cleaned[key] = cleanObjectRecursively(value);\n        } else {\n            cleaned[key] = value;\n        }\n    }\n    return cleaned;\n}\n\nif (typeof assaData === 'undefined') {\n    var assaData = getDataWithFallback(\"assa_data\");\n}\n\n// 获取数据\nvar player_analysis_gikumc = formatObjectGraceSimple(_.get(assaData, 'player_analysis', {}), 0, true, false);\n_%>\n\nmemory.load('global_lore.player_analysis', {\n    desc: \"对于玩家(<user>扮演者)及其<user>信息的分析和记录，你需要在生成内容时参考\",\n    path: 'global_lore.player_analysis <%=player_analysis_gikumc%>'\n});","useProbability":true,"probability":100,"excludeRecursion":false,"preventRecursion":false,"delayUntilRecursion":false,"sticky":0,"cooldown":0,"delay":0,"addMemo":true,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"group":"","groupOverride":false,"groupWeight":100,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","triggers":[]}}}